<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chips Tracker - FPL League</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .chips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
        }
        .manager-card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        .manager-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 1rem 1.5rem;
            color: var(--white);
        }
        .manager-header h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }
        .manager-header .team {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .chips-section {
            padding: 1rem 1.5rem;
        }
        .chips-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-600);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chips-section-title .gw-range {
            font-weight: 600;
            color: var(--primary);
        }
        .chips-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .chip-item {
            text-align: center;
            padding: 0.75rem 0.5rem;
            background: var(--gray-100);
            border-radius: 10px;
            transition: transform 0.2s;
        }
        .chip-item:hover {
            transform: scale(1.02);
        }
        .chip-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            margin: 0 auto 0.5rem;
            color: white;
        }
        .chip-icon.wc { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .chip-icon.fh { background: linear-gradient(135deg, #3498db, #2980b9); }
        .chip-icon.bb { background: linear-gradient(135deg, #e67e22, #d35400); }
        .chip-icon.tc { background: linear-gradient(135deg, #27ae60, #1e8449); }
        .chip-name {
            font-size: 0.7rem;
            color: var(--gray-600);
            margin-bottom: 0.35rem;
        }
        .chip-status {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            display: inline-block;
        }
        .chip-status.used {
            background: var(--accent);
            color: var(--primary);
        }
        .chip-status.available {
            background: var(--gray-200);
            color: var(--gray-600);
        }
        .chip-status.expired {
            background: var(--danger);
            color: var(--white);
        }
        .chip-status.locked {
            background: var(--gray-300);
            color: var(--gray-500);
        }
        .chip-item.expired {
            opacity: 0.5;
        }
        .chip-item.locked {
            opacity: 0.4;
        }
        .legend {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
            padding: 1rem 1.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legend-dot.used { background: var(--accent); }
        .legend-dot.available { background: var(--gray-300); }
        .legend-dot.expired { background: var(--danger); }
        .legend-dot.locked { background: var(--gray-400); }
        .summary-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .summary-stat {
            background: rgba(255,255,255,0.08);
            padding: 1.25rem;
            border-radius: 12px;
            text-align: center;
        }
        .summary-stat .number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
        }
        .summary-stat .label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.25rem;
        }
        .section-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 0;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-inner">
            <a href="/" class="navbar-brand">FPL Dashboard</a>
            <div class="navbar-links">
                <a href="/">Home</a>
                <a href="/standings">Standings</a>
                <a href="/losers">Weekly Losers</a>
                <a href="/motm">MotM</a>
                <a href="/chips" class="active">Chips</a>
                <a href="/earnings">Earnings</a>
                <a href="/rules">Rules</a>
            </div>
        </div>
    </nav>

    <div class="page-header">
        <h1 id="league-name">Loading...</h1>
        <p class="subtitle">Chips Tracker (25/26 Season)</p>
    </div>

    <main>
        <div id="content">
            <div class="loading">Loading chip data...</div>
        </div>
    </main>

    <script>
        const CHIP_NAMES = {
            'wildcard': 'Wildcard',
            'freehit': 'Free Hit',
            'bboost': 'Bench Boost',
            '3xc': 'Triple Cap'
        };

        const CHIP_ICONS = {
            'wildcard': { abbr: 'WC', class: 'wc' },
            'freehit': { abbr: 'FH', class: 'fh' },
            'bboost': { abbr: 'BB', class: 'bb' },
            '3xc': { abbr: 'TC', class: 'tc' }
        };

        const CHIP_ORDER = ['wildcard', 'freehit', 'bboost', '3xc'];

        async function loadChips() {
            try {
                const res = await fetch('/api/chips');
                const data = await res.json();

                document.getElementById('league-name').textContent = data.leagueName;

                // Calculate summary stats
                let firstHalfUsed = 0, firstHalfExpired = 0, firstHalfAvailable = 0;
                let secondHalfUsed = 0, secondHalfAvailable = 0, secondHalfLocked = 0;

                data.managers.forEach(m => {
                    CHIP_ORDER.forEach(chip => {
                        const fh = m.chips.firstHalf[chip];
                        const sh = m.chips.secondHalf[chip];

                        if (fh?.status === 'used') firstHalfUsed++;
                        else if (fh?.status === 'expired') firstHalfExpired++;
                        else if (fh?.status === 'available') firstHalfAvailable++;

                        if (sh?.status === 'used') secondHalfUsed++;
                        else if (sh?.status === 'available') secondHalfAvailable++;
                        else if (sh?.status === 'locked') secondHalfLocked++;
                    });
                });

                const inSecondHalf = data.currentGW >= 20;

                let html = `
                    <div class="summary-bar">
                        <div class="summary-stat">
                            <div class="number" style="color: var(--warning)">GW ${data.currentGW}</div>
                            <div class="label">Current Gameweek</div>
                        </div>
                        <div class="summary-stat">
                            <div class="number">${firstHalfUsed}</div>
                            <div class="label">1st Half Used</div>
                        </div>
                        <div class="summary-stat">
                            <div class="number" style="color: var(--danger)">${firstHalfExpired}</div>
                            <div class="label">1st Half Expired</div>
                        </div>
                        <div class="summary-stat">
                            <div class="number">${secondHalfUsed}</div>
                            <div class="label">2nd Half Used</div>
                        </div>
                        <div class="summary-stat">
                            <div class="number" style="color: ${inSecondHalf ? 'var(--accent)' : 'var(--gray-400)'}">${inSecondHalf ? secondHalfAvailable : secondHalfLocked}</div>
                            <div class="label">2nd Half ${inSecondHalf ? 'Available' : 'Locked'}</div>
                        </div>
                    </div>

                    <div class="legend">
                        <div class="legend-item"><span class="legend-dot used"></span> Used</div>
                        <div class="legend-item"><span class="legend-dot available"></span> Available</div>
                        <div class="legend-item"><span class="legend-dot expired"></span> Expired</div>
                        <div class="legend-item"><span class="legend-dot locked"></span> Locked (until GW20)</div>
                    </div>

                    <div class="chips-grid">
                `;

                data.managers.forEach(manager => {
                    html += `
                        <div class="manager-card">
                            <div class="manager-header">
                                <h3>${manager.name}</h3>
                                <div class="team">${manager.team}</div>
                            </div>

                            <div class="chips-section">
                                <div class="chips-section-title">
                                    <span>First Half</span>
                                    <span class="gw-range">GW 1-19</span>
                                </div>
                                <div class="chips-row">
                    `;

                    CHIP_ORDER.forEach(chipKey => {
                        const chip = manager.chips.firstHalf[chipKey];
                        const chipInfo = CHIP_ICONS[chipKey];
                        let statusText = chip?.status === 'used' ? `GW${chip.gw}` :
                                        chip?.status === 'expired' ? 'Expired' : 'Available';
                        let itemClass = chip?.status || 'available';

                        html += `
                            <div class="chip-item ${itemClass}">
                                <div class="chip-icon ${chipInfo.class}">${chipInfo.abbr}</div>
                                <div class="chip-name">${CHIP_NAMES[chipKey]}</div>
                                <span class="chip-status ${chip?.status || 'available'}">${statusText}</span>
                            </div>
                        `;
                    });

                    html += `
                                </div>
                            </div>

                            <div class="section-divider"></div>

                            <div class="chips-section">
                                <div class="chips-section-title">
                                    <span>Second Half</span>
                                    <span class="gw-range">GW 20-38</span>
                                </div>
                                <div class="chips-row">
                    `;

                    CHIP_ORDER.forEach(chipKey => {
                        const chip = manager.chips.secondHalf[chipKey];
                        const chipInfo = CHIP_ICONS[chipKey];
                        let statusText = chip?.status === 'used' ? `GW${chip.gw}` :
                                        chip?.status === 'locked' ? 'Locked' : 'Available';
                        let itemClass = chip?.status || 'available';

                        html += `
                            <div class="chip-item ${itemClass}">
                                <div class="chip-icon ${chipInfo.class}">${chipInfo.abbr}</div>
                                <div class="chip-name">${CHIP_NAMES[chipKey]}</div>
                                <span class="chip-status ${chip?.status || 'available'}">${statusText}</span>
                            </div>
                        `;
                    });

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="loading">Error: ${error.message}</div>`;
            }
        }

        loadChips();
    </script>
</body>
</html>
