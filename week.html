<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Weekly Scores - FPL League</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background: rgba(255,255,255,0.1); }
        th.sortable.asc::after { content: ' \2191'; opacity: 0.7; }
        th.sortable.desc::after { content: ' \2193'; opacity: 0.7; }

        /* Table styling - constrained to container, content wraps */
        .table-container {
            overflow-x: hidden;
        }

        .table-container table {
            width: 100%;
            table-layout: fixed;
        }

        .table-container .col-manager {
            width: auto;
        }

        .table-container .col-manager strong,
        .table-container .col-manager .team-name {
            display: block;
        }

        .table-container .captain-cell {
            text-align: left;
        }

        .table-container .vice-captain {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.1rem;
        }

        /* Compact numeric columns */
        .table-container th.num,
        .table-container td.num {
            width: 55px;
        }

        .table-container th:first-child,
        .table-container td:first-child {
            width: 36px;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--danger);
            color: var(--white);
            padding: 0.4rem 0.85rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .live-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--white);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .last-updated {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .chip-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .chip-badge.wildcard { background: #9b59b6; color: white; }
        .chip-badge.freehit { background: #3498db; color: white; }
        .chip-badge.bboost { background: #e67e22; color: white; }
        .chip-badge.3xc { background: #27ae60; color: white; }

        /* Manager info pills under team name */
        .manager-pills {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.35rem;
            flex-wrap: wrap;
        }
        .info-pill {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            line-height: 1.2;
        }
        .chip-pill.wildcard { background: #9b59b6; color: white; }
        .chip-pill.freehit { background: #3498db; color: white; }
        .chip-pill.bboost { background: #e67e22; color: white; }
        .chip-pill.3xc { background: #27ae60; color: white; }
        .left-pill { background: rgba(255, 255, 255, 0.15); color: rgba(255, 255, 255, 0.7); }

        /* Modal - Clean FPL App Style */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 0;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            overflow-y: auto;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #f5f5f5;
            border-radius: 0;
            width: 100%;
            min-height: 100%;
            overflow: visible;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        @media (min-width: 500px) {
            .modal-overlay {
                padding: 1rem;
                align-items: center;
            }
            .modal {
                max-width: 480px;
                border-radius: 20px;
                min-height: auto;
                max-height: 90vh;
                overflow: hidden;
            }
            .modal .modal-body {
                overflow-y: auto;
            }
        }

        @media (min-width: 768px) {
            .modal {
                max-width: 520px;
            }
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 1rem 1.5rem;
            padding-top: 2.5rem;
            position: relative;
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header-info {
            flex: 1;
            min-width: 0;
        }

        .modal-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal-header .team-name {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal-points {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
            margin-right: 2.5rem;
            flex-shrink: 0;
        }

        .modal-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 1.5rem;
            color: #fff;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            flex: 1;
            overflow-y: visible;
            padding: 0;
            background: var(--gray-900);
            overscroll-behavior: contain;
        }

        @media (min-width: 500px) {
            .modal-body {
                overflow-y: auto;
            }
        }

        /* Pitch - Full Width with green stripes */
        .pitch-container {
            background: linear-gradient(180deg,
                #3d9140 0%, #348f37 10%,
                #3d9140 10%, #348f37 20%,
                #3d9140 20%, #348f37 30%,
                #3d9140 30%, #348f37 40%,
                #3d9140 40%, #348f37 50%,
                #3d9140 50%, #348f37 60%,
                #3d9140 60%, #348f37 70%,
                #3d9140 70%, #348f37 80%,
                #3d9140 80%, #348f37 90%,
                #3d9140 90%, #348f37 100%
            );
            padding: 0.75rem 0;
            position: relative;
            border-radius: 0;
            margin: 0;
            width: 100%;
        }

        .pitch-markings {
            position: absolute;
            inset: 0.5rem 1rem;
            border: 2px solid rgba(255,255,255,0.35);
            pointer-events: none;
        }

        .pitch-center {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 50px;
            height: 50px;
            border: 2px solid rgba(255,255,255,0.35);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .pitch-halfway {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background: rgba(255,255,255,0.35);
        }

        .pitch-box-top {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 35px;
            border: 2px solid rgba(255,255,255,0.35);
            border-top: none;
        }

        .pitch-box-bottom {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 35px;
            border: 2px solid rgba(255,255,255,0.35);
            border-bottom: none;
        }

        .formation-row {
            display: flex;
            justify-content: center;
            gap: 2px;
            padding: 0.5rem 0;
            position: relative;
            z-index: 1;
        }

        .formation-row.gk { padding-top: 0.5rem; }
        .formation-row.fwd { padding-bottom: 0.5rem; }

        /* Player Card - Transparent, sized for 5 across with bigger shirts */
        .player-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: calc((100vw - 10px) / 5);
            max-width: 100px;
            min-width: 68px;
            cursor: pointer;
            position: relative;
            background: transparent;
            padding: 2px 0;
        }

        @media (min-width: 500px) {
            .player-card {
                width: calc((500px - 20px) / 5);
                max-width: 96px;
            }
        }

        .player-card.subbed-out {
            opacity: 0.35;
        }

        .player-card.subbed-in::before {
            content: 'â†‘';
            position: absolute;
            top: 0;
            left: 0;
            background: #27ae60;
            color: white;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            font-size: 0.55rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Shirt image - inflated for better visibility */
        .player-shirt {
            width: 57px;
            height: 57px;
            position: relative;
            margin-bottom: 2px;
        }

        .player-shirt img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
        }

        .captain-badge {
            position: absolute;
            bottom: 0;
            right: -4px;
            width: 15px;
            height: 15px;
            background: #000;
            color: white;
            border-radius: 50%;
            font-size: 0.55rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid white;
            z-index: 5;
        }

        .vice-badge {
            position: absolute;
            bottom: 0;
            right: -4px;
            width: 15px;
            height: 15px;
            background: #666;
            color: white;
            border-radius: 50%;
            font-size: 0.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid white;
            z-index: 5;
        }

        /* Player name - no background, clean text */
        .player-name-box {
            padding: 1px 3px;
            margin-bottom: 1px;
            max-width: 100%;
        }

        .player-name {
            font-family: 'Inter', sans-serif;
            font-size: 0.66rem;
            font-weight: 700;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc((100vw - 10px) / 5 - 8px);
            display: block;
            letter-spacing: -0.3px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8), 0 0 8px rgba(0,0,0,0.5);
        }

        @media (min-width: 500px) {
            .player-name {
                max-width: 80px;
            }
        }

        .player-points-pill {
            background: transparent;
            color: #fff;
            padding: 1px 5px;
            font-size: 0.77rem;
            font-weight: 800;
            min-width: 22px;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8), 0 0 6px rgba(0,0,0,0.5);
        }

        .player-points-pill.not-played {
            color: rgba(255,255,255,0.6);
            font-size: 0.55rem;
        }

        /* Yellow border for active match */
        .player-card.playing {
            border: 2px solid #ffc107;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
        }

        /* Faded for finished matches */
        .player-card.finished {
            opacity: 0.6;
        }

        .provisional-bonus {
            font-size: 0.5rem;
            color: #00ff85;
            margin-left: 1px;
            font-weight: 600;
        }

        .player-events {
            display: flex;
            gap: 1px;
            margin-top: 1px;
            font-size: 0.5rem;
        }

        /* Bench Area */
        .bench-container {
            background: var(--gray-800);
            padding: 0.5rem 0.75rem;
        }

        .bench-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .bench-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bench-points {
            font-size: 0.75rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.5);
        }

        .bench-row {
            display: flex;
            justify-content: space-around;
        }

        .bench-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bench-slot .player-card {
            width: calc((100vw - 10px) / 5);
            max-width: 100px;
            min-width: 68px;
        }

        .bench-slot .player-shirt {
            width: 57px;
            height: 57px;
        }

        .bench-slot .player-name {
            max-width: calc((100vw - 10px) / 5 - 8px);
            font-size: 0.66rem;
        }

        .bench-slot .player-points-pill {
            font-size: 0.77rem;
            padding: 1px 5px;
        }

        .bench-position {
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.2rem;
            font-weight: 600;
        }

        /* Formation Label */
        .formation-bar {
            background: var(--gray-800);
            padding: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .formation-bar strong {
            color: var(--accent);
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: #333;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-header {
            font-weight: 700;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #555;
            padding-bottom: 0.35rem;
        }

        .tooltip-row {
            display: flex;
            gap: 1.5rem;
            padding: 0.3rem 0;
            align-items: center;
        }

        .tooltip-row .stat {
            color: #ccc;
        }

        .tooltip-row .value {
            margin-left: auto;
            color: #aaa;
        }

        .tooltip-row .pts {
            min-width: 45px;
            text-align: right;
            font-weight: 600;
        }

        .tooltip-row.total {
            margin-top: 0.5rem;
            border-top: 1px solid #555;
            padding-top: 0.5rem;
            font-weight: 700;
        }

        .tooltip-row.total .stat {
            color: white;
        }

        /* Mobile bottom sheet for player details */
        .player-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gray-800);
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            z-index: 2501;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
            max-height: 50vh;
            overflow-y: auto;
        }

        .player-sheet.visible {
            transform: translateY(0);
        }

        .player-sheet-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .player-sheet-badge {
            width: 50px;
            height: 50px;
            position: relative;
        }

        .player-sheet-badge img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .player-sheet-info h3 {
            font-size: 1.1rem;
            color: #fff;
            margin: 0;
        }

        .player-sheet-info p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
        }

        .player-sheet-points {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
            margin-left: auto;
        }

        .points-breakdown {
            background: var(--gray-900);
            border-radius: 12px;
            overflow: hidden;
        }

        .breakdown-header {
            display: grid;
            grid-template-columns: 1fr 60px 70px;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
        }

        .breakdown-row {
            display: grid;
            grid-template-columns: 1fr 60px 70px;
            padding: 0.6rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .breakdown-row:last-child {
            border-bottom: none;
        }

        .breakdown-stat {
            color: rgba(255, 255, 255, 0.9);
        }

        .breakdown-value {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
        }

        .breakdown-pts {
            text-align: right;
            font-weight: 600;
            color: #27ae60;
        }

        .breakdown-pts.negative {
            color: #e74c3c;
        }

        .breakdown-total {
            display: grid;
            grid-template-columns: 1fr 60px 70px;
            padding: 0.75rem 1rem;
            background: var(--primary);
            color: white;
            font-weight: 700;
        }

        .breakdown-total span:last-child {
            text-align: right;
        }

        .sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sheet-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Auto-subs indicator */
        .auto-subs-bar {
            background: rgba(255, 193, 7, 0.15);
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: var(--warning);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auto-subs-bar svg {
            width: 16px;
            height: 16px;
        }

        /* GW Navigation - positioned at top of header */
        .gw-nav {
            position: absolute;
            top: 0.5rem;
            left: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .gw-nav-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            transition: background 0.2s, opacity 0.2s, transform 0.15s;
        }

        .gw-nav-btn svg {
            width: 18px;
            height: 18px;
            stroke-width: 2.5;
        }

        .gw-nav-btn:hover:not(:disabled) {
            background: var(--accent);
            color: var(--primary);
            transform: scale(1.1);
        }

        .gw-nav-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .gw-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .gw-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
            min-width: 55px;
            text-align: center;
        }

        /* Tinkering Bar */
        .tinkering-bar {
            background: var(--gray-800);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background 0.2s;
        }

        .tinkering-bar:hover {
            background: var(--gray-700);
        }

        .tinkering-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
        }

        .tinkering-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .tinkering-title svg {
            width: 16px;
            height: 16px;
            color: rgba(255, 255, 255, 0.5);
        }

        .tinkering-impact {
            font-size: 1rem;
            font-weight: 700;
        }

        .tinkering-impact.positive {
            color: #27ae60;
        }

        .tinkering-impact.negative {
            color: #e74c3c;
        }

        .tinkering-impact.neutral {
            color: rgba(255, 255, 255, 0.6);
        }

        .tinkering-toggle {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            transition: transform 0.2s;
        }

        .tinkering-bar.expanded .tinkering-toggle {
            transform: rotate(180deg);
        }

        .tinkering-details {
            display: none;
            padding: 0 1rem 1rem;
            font-size: 0.85rem;
        }

        .tinkering-bar.expanded .tinkering-details {
            display: block;
        }

        .tinkering-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid rgba(255, 255, 255, 0.2);
        }

        .tinkering-row {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }

        .tinkering-row.total {
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            font-weight: 700;
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
            margin: 0.5rem -0.75rem -0.75rem;
            padding: 0.75rem;
            border-radius: 0 0 4px 4px;
        }

        .tinkering-row.total .tinkering-impact {
            font-size: 1rem;
        }

        .tinkering-section {
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .tinkering-section.positive-section {
            border-left: 4px solid #27ae60;
        }

        .tinkering-section.negative-section {
            border-left: 4px solid #e74c3c;
        }

        .tinkering-section.neutral-section {
            border-left: 4px solid #3498db;
        }

        .tinkering-section-total {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed rgba(255, 255, 255, 0.2);
            font-weight: 600;
            font-size: 0.8rem;
        }

        .tinkering-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .tinkering-section-title.positive {
            color: #27ae60;
        }

        .tinkering-section-title.negative {
            color: #e74c3c;
        }

        .tinkering-item {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
            color: rgba(255, 255, 255, 0.7);
        }

        .tinkering-item .points {
            font-weight: 600;
        }

        .tinkering-item .points.positive {
            color: #27ae60;
        }

        .tinkering-item .points.negative {
            color: #e74c3c;
        }

        .tinkering-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        .tinkering-badge.freehit {
            background: #3498db;
            color: white;
        }

        .tinkering-badge.wildcard {
            background: #9b59b6;
            color: white;
        }

        .tinkering-unavailable {
            padding: 0.75rem 1rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            text-align: center;
        }

        /* Events Ticker */
        .ticker-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        .ticker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .ticker-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ticker-header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ticker-header .last-updated {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .ticker-header .live-indicator {
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .ticker-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ticker-title.live {
            color: var(--danger);
        }

        .next-kickoff {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .ticker-track {
            overflow-x: auto;
            white-space: nowrap;
            padding: 0.75rem 1rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }

        .ticker-track::-webkit-scrollbar {
            height: 4px;
        }

        .ticker-track::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        .ticker-events {
            display: inline-flex;
            gap: 1rem;
        }

        .ticker-event {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.08);
            padding: 0.5rem 0.9rem;
            border-radius: 20px;
            font-size: 0.85rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .ticker-event .event-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .ticker-event .event-points {
            font-weight: 700;
            color: var(--accent);
        }

        .ticker-event .event-points.negative {
            color: var(--danger);
        }

        .ticker-event.transfer-hit {
            background: rgba(231, 76, 60, 0.25);
            border: 1px solid rgba(231, 76, 60, 0.5);
        }

        .ticker-event.goal {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid rgba(39, 174, 96, 0.4);
        }

        .ticker-event.assist {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.4);
        }

        .ticker-event.yellow {
            background: rgba(241, 196, 15, 0.2);
            border: 1px solid rgba(241, 196, 15, 0.4);
        }

        .ticker-event.red {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.4);
        }

        .ticker-event.own_goal {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.4);
        }

        .ticker-event.pen_save {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid rgba(39, 174, 96, 0.4);
        }

        .ticker-event.pen_miss {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.4);
        }

        .ticker-event.bonus {
            background: rgba(0, 255, 135, 0.2);
            border: 1px solid rgba(0, 255, 135, 0.4);
        }

        .ticker-event.saves {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.4);
        }

        .ticker-event.clean_sheet {
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid rgba(155, 89, 182, 0.4);
        }

        .ticker-event.goals_conceded {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.4);
        }

        .ticker-event.defcon {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.4);
        }

        /* Change events - more prominent styling */
        .ticker-event.change-event {
            border-width: 2px;
            animation: change-pulse 2s ease-out;
        }

        @keyframes change-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        .ticker-event.bonus_change {
            background: rgba(255, 215, 0, 0.25);
            border: 2px solid rgba(255, 215, 0, 0.6);
        }

        .ticker-event.cs_lost {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid rgba(231, 76, 60, 0.6);
        }

        .ticker-event.defcon_gained {
            background: rgba(46, 204, 113, 0.3);
            border: 2px solid rgba(46, 204, 113, 0.6);
        }

        .ticker-event .minute {
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.5);
            margin-left: 0.25rem;
        }

        .ticker-event .impact-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: 0.3rem;
        }

        .ticker-event .impact-badge.positive {
            background: rgba(0, 255, 135, 0.3);
            color: var(--accent);
        }

        .ticker-event .impact-badge.negative {
            background: rgba(231, 76, 60, 0.3);
            color: var(--danger);
        }

        /* Bonus popup */
        .bonus-popup {
            position: fixed;
            background: var(--gray-900);
            border: 1px solid rgba(0, 255, 135, 0.4);
            border-radius: 8px;
            padding: 0.75rem;
            z-index: 3000;
            min-width: 180px;
            max-width: 250px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .bonus-popup.visible {
            display: block;
        }

        .bonus-popup-header {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.5rem;
            padding-bottom: 0.35rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bonus-player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.2rem 0;
            font-size: 0.7rem;
        }

        .bonus-player-row .name {
            color: rgba(255, 255, 255, 0.9);
        }

        .bonus-player-row .bps {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.6rem;
            margin-left: 0.3rem;
        }

        .bonus-player-row .bonus-pts {
            font-weight: 700;
            color: var(--accent);
            min-width: 20px;
            text-align: right;
        }

        .bonus-player-row.near-miss {
            opacity: 0.5;
        }

        .bonus-player-row.near-miss .bonus-pts {
            color: rgba(255, 255, 255, 0.4);
        }

        .bonus-section-label {
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 0.4rem;
            margin-bottom: 0.2rem;
        }

        .ticker-event {
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .ticker-event:hover {
            transform: scale(1.05);
        }

        .ticker-event.selected {
            box-shadow: 0 0 0 2px var(--accent);
            transform: scale(1.05);
        }

        /* Event impact badge */
        .event-impact {
            display: inline-flex;
            align-items: center;
            margin-left: 0.4rem;
            padding: 0.15rem 0.35rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            animation: impact-pop 0.3s ease-out;
        }

        @keyframes impact-pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .event-impact.positive {
            background: rgba(0, 255, 135, 0.2);
            color: var(--accent);
        }

        .event-impact.negative {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        .event-impact .arrow {
            margin-right: 0.15rem;
            font-size: 0.6rem;
        }

        .ticker-event .icon {
            font-size: 0.85rem;
        }

        .ticker-event .player {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .ticker-event .match {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.65rem;
        }

        .ticker-event .affected-count {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.65rem;
            font-weight: 500;
        }

        .ticker-empty {
            padding: 0.75rem 1rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }

        /* Fixtures Mini Display */
        .fixtures-bar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.03);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .fixture-mini {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .fixture-mini.live {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        .fixture-mini.finished {
            color: rgba(255, 255, 255, 0.4);
        }

        .fixture-mini .score {
            font-weight: 700;
        }

        .fixture-mini {
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }

        .fixture-mini:hover {
            background: rgba(0, 255, 135, 0.2);
            transform: scale(1.05);
        }

        /* Match Stats Modal */
        .match-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            overflow-y: auto;
        }

        .match-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .match-modal {
            background: var(--gray-900);
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            margin: 2rem auto;
            transform: scale(0.95);
            transition: transform 0.3s;
            border: 1px solid rgba(0, 255, 135, 0.2);
        }

        .match-modal-overlay.active .match-modal {
            transform: scale(1);
        }

        .match-modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 1.25rem;
            border-radius: 16px 16px 0 0;
            text-align: center;
            position: relative;
        }

        .match-modal-header .close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .match-teams {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
        }

        .match-score {
            font-size: 1.5rem;
            background: rgba(0,0,0,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
        }

        .match-status {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.5rem;
        }

        .match-modal-body {
            padding: 1rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Side-by-side teams container */
        .teams-side-by-side {
            display: flex;
            gap: 0;
            margin-bottom: 1.5rem;
        }

        .team-column {
            flex: 1;
            min-width: 0;
        }

        .team-column.home {
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .team-column-header {
            font-size: 0.9rem;
            font-weight: 700;
            color: rgba(255,255,255,0.95);
            padding: 0.75rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .team-column.home .team-column-header {
            border-radius: 8px 0 0 0;
        }

        .team-column.away .team-column-header {
            border-radius: 0 8px 0 0;
        }

        /* Player rows in side-by-side view */
        .player-row-sbs {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.5rem;
            font-size: 0.8rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            min-height: 40px;
            gap: 0.3rem;
        }

        .player-row-sbs:last-child {
            border-bottom: none;
        }

        .player-row-sbs .player-name-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex: 1;
            min-width: 0;
        }

        .player-row-sbs .player-name {
            color: rgba(255,255,255,0.9);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-row-sbs .player-icons {
            display: flex;
            gap: 0.15rem;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .player-row-sbs .player-pts {
            font-weight: 700;
            font-size: 0.9rem;
            min-width: 28px;
            text-align: center;
            color: white;
            flex-shrink: 0;
        }

        /* Home team: Name+icons left, score right */
        .team-column.home .player-row-sbs {
            flex-direction: row;
        }

        .team-column.home .player-row-sbs .player-name-group {
            justify-content: flex-start;
        }

        /* Away team: Score left, icons+name right */
        .team-column.away .player-row-sbs {
            flex-direction: row;
        }

        .team-column.away .player-row-sbs .player-name-group {
            justify-content: flex-end;
        }

        .player-pts.positive { color: var(--accent) !important; }
        .player-pts.negative { color: var(--danger) !important; }
        .player-pts.zero { color: rgba(255,255,255,0.4) !important; }

        /* Clickable player rows */
        .player-row-sbs.clickable {
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .player-row-sbs.clickable:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Team divider between starters and subs */
        .team-divider {
            font-size: 0.65rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.5rem 0.5rem 0.3rem;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            margin-top: 0.25rem;
        }

        .player-icon {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .player-icon .icon-count {
            position: absolute;
            bottom: -2px;
            right: -2px;
            font-size: 0.5rem;
            font-weight: 700;
            color: white;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            width: 12px;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .player-icon.cs {
            background: rgba(155, 89, 182, 0.3);
        }

        .player-icon.goal {
            background: rgba(39, 174, 96, 0.3);
        }

        .player-icon.assist {
            background: rgba(52, 152, 219, 0.3);
        }

        .player-icon.yellow {
            background: rgba(241, 196, 15, 0.3);
        }

        .player-icon.red {
            background: rgba(231, 76, 60, 0.3);
        }

        /* Stats tables (DC, Saves, BP) - consistent with main table */
        .stats-tables-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .stats-table-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
        }

        .stats-table-header {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent);
            padding: 0.75rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-table {
            display: flex;
            flex-direction: column;
        }

        .stats-table-row {
            display: flex;
            font-size: 0.8rem;
            min-height: 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stats-table-row:last-child {
            border-bottom: none;
        }

        .stats-table-col {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 0.4rem 0.5rem;
            gap: 0.3rem;
        }

        .stats-table-col.home {
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-player-name {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stats-table-col.home .stats-player-name {
            text-align: left;
        }

        .stats-table-col.away .stats-player-name {
            text-align: right;
        }

        /* DC value styling */
        .dc-value, .saves-value, .bp-value {
            font-size: 0.8rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.5);
            min-width: 28px;
            text-align: center;
            flex-shrink: 0;
        }

        .dc-value.achieved, .saves-value.achieved, .bp-value .bp-earned {
            color: var(--accent);
        }

        .bp-value {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        .bp-earned {
            font-weight: 700;
        }

        /* Legacy styles kept for backwards compatibility */
        .team-section {
            margin-bottom: 1.5rem;
        }

        .team-section-header {
            font-size: 0.85rem;
            font-weight: 700;
            color: rgba(255,255,255,0.9);
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 0.5rem;
        }

        .player-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            font-size: 0.8rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .player-stat-row:last-child {
            border-bottom: none;
        }

        .player-stat-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .player-stat-name {
            color: rgba(255,255,255,0.9);
        }

        .player-stat-pos {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.4);
        }

        .player-stat-events {
            display: flex;
            gap: 0.25rem;
            font-size: 0.7rem;
        }

        .player-stat-pts {
            font-weight: 700;
            min-width: 30px;
            text-align: right;
        }

        .player-stat-pts.positive { color: var(--success); }
        .player-stat-pts.negative { color: var(--danger); }
        .player-stat-pts.zero { color: rgba(255,255,255,0.4); }

        .stat-badge {
            display: inline-block;
            padding: 0.1rem 0.25rem;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .stat-badge.goal { background: rgba(39, 174, 96, 0.3); color: #27ae60; }

        /* Show Matches Button */
        .show-matches-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .show-matches-btn:hover {
            background: rgba(0, 255, 135, 0.2);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Fixtures List Modal */
        .fixtures-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            overflow-y: auto;
        }

        .fixtures-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .fixtures-modal {
            background: var(--gray-900);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            margin: 2rem auto;
            transform: scale(0.95);
            transition: transform 0.3s;
            border: 1px solid rgba(0, 255, 135, 0.2);
        }

        .fixtures-modal-overlay.active .fixtures-modal {
            transform: scale(1);
        }

        .fixtures-modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 1rem 1.25rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fixtures-modal-header h3 {
            margin: 0;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .fixtures-modal-header .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .fixtures-modal-body {
            padding: 1rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .fixture-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .fixture-item:hover {
            background: rgba(0, 255, 135, 0.1);
        }

        .fixture-item.live {
            border: 2px solid var(--warning);
            background: rgba(255, 193, 7, 0.1);
        }

        .fixture-item.finished {
            opacity: 0.7;
        }

        .fixture-team {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .fixture-team.home {
            text-align: right;
            padding-right: 0.75rem;
        }

        .fixture-team.away {
            text-align: left;
            padding-left: 0.75rem;
        }

        .fixture-score {
            min-width: 60px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .fixture-kickoff {
            min-width: 60px;
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .fixture-status {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .fixture-status.live {
            background: var(--warning);
            color: black;
            font-weight: 700;
        }

        .fixture-status.ft {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
        }

        /* BPS Section in Match Modal */
        .bps-section {
            margin-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1rem;
        }

        .bps-section-header {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bps-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
        }

        .bps-row.bonus-3 {
            background: rgba(255, 215, 0, 0.2);
        }

        .bps-row.bonus-2 {
            background: rgba(192, 192, 192, 0.15);
        }

        .bps-row.bonus-1 {
            background: rgba(205, 127, 50, 0.15);
        }

        .bps-player {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .bps-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bps-score {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .bps-bonus {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent);
            min-width: 24px;
            text-align: right;
        }
        .stat-badge.assist { background: rgba(52, 152, 219, 0.3); color: #3498db; }
        .stat-badge.cs { background: rgba(155, 89, 182, 0.3); color: #9b59b6; }
        .stat-badge.yellow { background: rgba(241, 196, 15, 0.3); color: #f1c40f; }
        .stat-badge.red { background: rgba(231, 76, 60, 0.3); color: #e74c3c; }
        .stat-badge.bonus { background: rgba(0, 255, 135, 0.3); color: var(--accent); }

        /* Mobile fullscreen for match and fixtures modals */
        @media (max-width: 768px) {
            .match-modal-overlay,
            .fixtures-modal-overlay {
                padding: 0;
            }
            .match-modal,
            .fixtures-modal {
                max-width: 100%;
                min-height: 100%;
                margin: 0;
                border-radius: 0;
                border: none;
                display: flex;
                flex-direction: column;
            }
            .match-modal-header,
            .fixtures-modal-header {
                border-radius: 0;
            }
            .match-modal-body,
            .fixtures-modal-body {
                flex: 1;
                max-height: none;
                overflow-y: auto;
            }

            /* Side-by-side still works on mobile but with tighter spacing */
            .teams-side-by-side {
                gap: 0;
            }

            .team-column-header {
                font-size: 0.8rem;
                padding: 0.5rem 0.25rem;
            }

            .player-row-sbs {
                padding: 0.35rem 0.25rem;
                min-height: 38px;
            }

            .player-row-sbs .player-name {
                font-size: 0.75rem;
            }

            .player-row-sbs .player-pts {
                font-size: 0.85rem;
                min-width: 28px;
            }

            .player-icon {
                width: 16px;
                height: 16px;
                font-size: 0.6rem;
            }

            /* Stats tables stack on very small screens */
            .stats-tables-container {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .stats-table-row {
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            .team-column-header {
                font-size: 0.75rem;
            }

            .player-row-sbs .player-name {
                font-size: 0.7rem;
            }

            .player-row-sbs .player-pos {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-inner">
            <a href="/" class="navbar-brand">Barry's FPL Mini League</a>
            <button class="nav-toggle" onclick="this.classList.toggle('active');document.querySelector('.navbar-links').classList.toggle('active')">
                <span></span><span></span><span></span>
            </button>
            <div class="navbar-links">
                <a href="/">Home</a>
                <a href="/week" class="active">Weekly Scores</a>
                <a href="/standings">Standings</a>
                <a href="/losers">Weekly Losers</a>
                <a href="/motm">MotM</a>
                <a href="/chips">Chips</a>
                <a href="/earnings">Earnings</a>
                <a href="/cup">Cup</a>
                <a href="/hall-of-fame">Hall of Fame</a>
                <a href="/set-and-forget">Set & Forget</a>
                <a href="/rules">Rules</a>
                <a href="/admin" class="mobile-only">Admin</a>
            </div>
        </div>
    </nav>

    <!-- API Status Banner -->
    <div class="api-status-banner" id="api-status-banner">
        <span class="banner-icon">âš ï¸</span>
        <span id="api-status-message">FPL API temporarily unavailable. Showing cached data.</span>
        <span class="banner-time" id="api-status-time"></span>
    </div>

    <div class="page-header">
        <h1 id="league-name">Loading...</h1>
        <p class="subtitle" id="gw-subtitle">Current Week</p>
    </div>

    <main>
        <div id="content">
            <div class="loading">Loading week data...</div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="gw-nav">
                    <button class="gw-nav-btn" id="gw-prev" onclick="navigateGW(-1)" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>
                    <span class="gw-label" id="gw-label">GW 1</span>
                    <button class="gw-nav-btn" id="gw-next" onclick="navigateGW(1)" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
                <div class="modal-header-info">
                    <h2 id="modal-manager-name">Manager</h2>
                    <div class="team-name" id="modal-team-name"></div>
                </div>
                <div class="modal-points" id="modal-points">0</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
        </div>
    </div>

    <!-- Tooltip for desktop -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Mobile player sheet -->
    <div class="sheet-overlay" id="sheet-overlay" onclick="closePlayerSheet()"></div>
    <div class="player-sheet" id="player-sheet"></div>

    <!-- Bonus Popup -->
    <div class="bonus-popup" id="bonus-popup"></div>

    <!-- Fixtures List Modal -->
    <div class="fixtures-modal-overlay" id="fixtures-modal-overlay" onclick="closeFixturesModal(event)">
        <div class="fixtures-modal" onclick="event.stopPropagation()">
            <div class="fixtures-modal-header">
                <h3 id="fixtures-modal-title">Gameweek Fixtures</h3>
                <button class="close-btn" onclick="closeFixturesModal()">&times;</button>
            </div>
            <div class="fixtures-modal-body" id="fixtures-modal-body">
            </div>
        </div>
    </div>

    <!-- Match Stats Modal -->
    <div class="match-modal-overlay" id="match-modal-overlay" onclick="closeMatchModal(event)">
        <div class="match-modal" onclick="event.stopPropagation()">
            <div class="match-modal-header">
                <button class="close-btn" onclick="closeMatchModal()">&times;</button>
                <div class="match-teams" id="match-teams">Loading...</div>
                <div class="match-status" id="match-status"></div>
            </div>
            <div class="match-modal-body" id="match-modal-body">
                <div class="loading" style="text-align: center; padding: 2rem;">Loading match data...</div>
            </div>
        </div>
    </div>

    <script>
        let weekData = null;
        let currentPicksData = null;
        let currentTinkeringData = null;
        let currentModalGW = null;
        let currentModalEntryId = null;
        let currentMatchStatsData = null;
        let currentSort = { col: 'gwScore', asc: false };
        let selectedEventIdx = null; // Currently selected event for impact display
        let selectedChangeIdx = null; // Currently selected change event
        let selectedChronoIdx = null; // Currently selected chronological event
        let refreshInterval = null;
        let isMobile = window.innerWidth < 768;

        const CHIP_NAMES = {
            'wildcard': 'WC',
            'freehit': 'FH',
            'bboost': 'BB',
            '3xc': 'TC'
        };

        const POSITION_LABELS = ['GKP', '1st Sub', '2nd Sub', '3rd Sub'];

        function sortTable(col) {
            if (currentSort.col === col) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.col = col;
                currentSort.asc = col === 'manager';
            }

            const sortKey = {
                'gwRank': m => m.gwRank,
                'manager': m => m.name.toLowerCase(),
                'overallPoints': m => m.overallPoints || 0,
                'captain': m => (m.captainName || '').toLowerCase(),
                'gwScore': m => m.gwScore,
                'playersLeft': m => m.playersLeft,
                'teamValue': m => parseFloat(m.teamValue),
                'benchPoints': m => m.benchPoints
            }[col];

            weekData.managers.sort((a, b) => {
                const aVal = sortKey(a), bVal = sortKey(b);
                if (typeof aVal === 'string') return currentSort.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                return currentSort.asc ? aVal - bVal : bVal - aVal;
            });

            renderTable();
        }

        function sortClass(col) {
            if (currentSort.col !== col) return '';
            return currentSort.asc ? 'asc' : 'desc';
        }

        function renderTable() {
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable ${sortClass('gwRank')}" onclick="sortTable('gwRank')">#</th>
                            <th class="col-manager sortable ${sortClass('manager')}" onclick="sortTable('manager')">Manager</th>
                            <th class="num sortable ${sortClass('overallPoints')}" onclick="sortTable('overallPoints')">Overall</th>
                            <th class="sortable ${sortClass('captain')}" onclick="sortTable('captain')">Captain</th>
                            <th class="num sortable ${sortClass('gwScore')}" onclick="sortTable('gwScore')">Pts</th>
                            <th class="num sortable ${sortClass('benchPoints')}" onclick="sortTable('benchPoints')">Bench</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            weekData.managers.forEach(m => {
                const rankClass = m.gwRank <= 3 ? `rank-${m.gwRank}` : '';

                // Build info pills for under team name
                let pills = [];
                if (m.activeChip) {
                    pills.push(`<span class="info-pill chip-pill ${m.activeChip}">${CHIP_NAMES[m.activeChip]}</span>`);
                }
                if (m.playersLeft > 0) {
                    pills.push(`<span class="info-pill left-pill">${m.playersLeft} left</span>`);
                }
                const pillsHtml = pills.length > 0 ? `<div class="manager-pills">${pills.join('')}</div>` : '';

                // Event impact badge
                const impact = getEventImpactForManager(m);
                let impactHtml = '';
                if (impact !== null) {
                    const isPositive = impact >= 0;
                    const impactClass = isPositive ? 'positive' : 'negative';
                    const arrow = isPositive ? 'â–²' : 'â–¼';
                    impactHtml = `<span class="event-impact ${impactClass}"><span class="arrow">${arrow}</span>${Math.abs(impact)}</span>`;
                }

                html += `
                    <tr class="clickable" onclick="openManagerModal(${m.entryId})">
                        <td class="rank-cell ${rankClass}">${m.gwRank}</td>
                        <td class="col-manager">
                            <strong>${m.name}</strong>
                            <div class="team-name">${m.team}</div>
                            ${pillsHtml}
                        </td>
                        <td class="num">${m.overallPoints || 0}</td>
                        <td class="captain-cell">
                            ${m.captainName || '-'}
                            ${m.viceCaptainName ? `<div class="vice-captain">${m.viceCaptainName}</div>` : ''}
                        </td>
                        <td class="num"><span class="badge badge-success">${m.gwScore}</span>${impactHtml}</td>
                        <td class="num">${m.benchPoints}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.querySelector('.table-container').innerHTML = html;
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const time = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            if (isToday) return time;
            // Show date if not today so users know data is older
            const day = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            return `${day} ${time}`;
        }

        function formatKickoffTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const time = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            if (isToday) return `Today ${time}`;
            const day = date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
            return `${day} ${time}`;
        }

        function buildTickerHtml(data) {
            if (!data) return '';

            const chronoEvents = data.chronologicalEvents || [];
            const liveEvents = data.liveEvents || [];
            const fixtures = data.fixtures || [];
            const nextKickoff = data.nextKickoff;
            const hasLiveMatches = fixtures.some(f => f.started && !f.finished);

            // Extract transfer hits from liveEvents (they go at the beginning)
            const transferHits = liveEvents.filter(e => e.isTransferHit);

            // Event type to label mapping
            const EVENT_LABELS = {
                'goal': 'Goal',
                'assist': 'Assist',
                'yellow': 'Yellow',
                'red': 'Red',
                'own_goal': 'OG',
                'pen_save': 'Pen Save',
                'pen_miss': 'Pen Miss',
                'saves': 'Save Pt',
                'clean_sheet': 'CS',
                'team_clean_sheet': 'CS',
                'goals_conceded': 'GC',
                'team_goals_conceded': 'GC',
                'bonus_change': 'Bonus',
                'defcon': 'Defcon',
                'transfer_hit': 'Hit'
            };

            // Build transfer hit items (shown at beginning)
            const transferHitItems = transferHits.map((e, idx) => {
                const pointsDisplay = `${e.points}`;
                return `<div class="ticker-event transfer-hit" data-event-idx="${idx}">
                    <span class="icon">${e.icon}</span>
                    <span class="player">${e.player}</span>
                    <span class="event-label">Hit</span>
                    <span class="event-points negative">${pointsDisplay}</span>
                </div>`;
            }).join('');

            // Build chronological event items
            const chronoEventItems = chronoEvents.map((e, idx) => {
                const label = EVENT_LABELS[e.type] || '';
                const pointsClass = e.points >= 0 ? '' : 'negative';
                const pointsDisplay = e.points !== null ? (e.points >= 0 ? `+${e.points}` : `${e.points}`) : '';

                // Bonus change events
                if (e.type === 'bonus_change') {
                    const changes = e.changes || [];
                    const changesPreview = changes.slice(0, 2).map(c => {
                        const arrow = c.impact > 0 ? 'â–²' : (c.impact < 0 ? 'â–¼' : '');
                        return `${arrow}${c.player}`;
                    }).join(', ');

                    return `<div class="ticker-event bonus_change" onclick="showChronoBonusPopup(event, ${idx})" data-chrono-idx="${idx}">
                        <span class="icon">${e.icon}</span>
                        <span class="player">${changesPreview}</span>
                        <span class="event-label">${label}</span>
                        <span class="match">${e.match}</span>
                    </div>`;
                }

                // Team events (clean sheets and goals conceded grouped by team)
                if (e.type === 'team_clean_sheet' || e.type === 'team_goals_conceded') {
                    const players = e.affectedPlayers || [];
                    const playerCount = players.length;
                    const cssClass = e.type === 'team_clean_sheet' ? 'clean_sheet' : 'goals_conceded';

                    return `<div class="ticker-event ${cssClass}" onclick="showTeamEventPopup(event, ${idx})" data-chrono-idx="${idx}">
                        <span class="icon">${e.icon}</span>
                        <span class="player">${e.team}</span>
                        <span class="event-label">${label}</span>
                        <span class="event-points ${pointsClass}">${pointsDisplay}</span>
                        <span class="affected-count">(${playerCount})</span>
                        <span class="match">${e.match}</span>
                    </div>`;
                }

                // Regular events
                return `<div class="ticker-event ${e.type}" onclick="showChronoEventImpact(${idx})" data-chrono-idx="${idx}">
                    <span class="icon">${e.icon}</span>
                    <span class="player">${e.player}</span>
                    <span class="event-label">${label}</span>
                    <span class="event-points ${pointsClass}">${pointsDisplay}</span>
                    <span class="match">${e.match}</span>
                </div>`;
            }).join('');

            // Build events ticker - transfer hits first, then chronological events
            let eventsHtml = '';
            const allEventItems = transferHitItems + chronoEventItems;
            if (allEventItems.length > 0) {
                eventsHtml = `
                    <div class="ticker-track" id="ticker-track">
                        <div class="ticker-events">${allEventItems}</div>
                    </div>
                `;
            } else if (hasLiveMatches) {
                eventsHtml = `<div class="ticker-empty">Events from live matches will appear here</div>`;
            } else if (nextKickoff) {
                eventsHtml = `<div class="ticker-empty">Next match: ${formatKickoffTime(nextKickoff)}</div>`;
            } else {
                eventsHtml = `<div class="ticker-empty">No live matches</div>`;
            }

            const titleClass = hasLiveMatches ? 'live' : '';
            const titleText = hasLiveMatches ? 'Live Events' : 'Match Events';
            const clearBtnClass = (selectedEventIdx !== null || selectedChronoIdx !== null) ? 'visible' : '';

            // Build last updated and live indicator for ticker header
            const liveIndicator = data.isLive ? '<span class="live-indicator">LIVE</span>' : '';
            const lastUpdatedText = data.lastUpdated ? `<span class="last-updated">Updated ${formatTime(data.lastUpdated)}</span>` : '';

            return `
                <div class="ticker-container">
                    <div class="ticker-header">
                        <div class="ticker-header-left">
                            <span class="ticker-title ${titleClass}">${titleText}</span>
                            ${liveIndicator}
                        </div>
                        <div class="ticker-header-right">
                            ${lastUpdatedText}
                            <button class="show-matches-btn" onclick="event.stopPropagation(); openFixturesModal();">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                Matches
                            </button>
                            ${nextKickoff && !hasLiveMatches ? `<span class="next-kickoff">Next: ${formatKickoffTime(nextKickoff)}</span>` : ''}
                        </div>
                    </div>
                    ${eventsHtml}
                </div>
            `;
        }

        function showApiBanner(message, lastRefresh) {
            const banner = document.getElementById('api-status-banner');
            const msgEl = document.getElementById('api-status-message');
            const timeEl = document.getElementById('api-status-time');

            msgEl.textContent = message || 'FPL API temporarily unavailable. Showing cached data.';
            if (lastRefresh) {
                const date = new Date(lastRefresh);
                timeEl.textContent = `(Data from ${date.toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })})`;
            }
            banner.classList.add('visible');
        }

        function hideApiBanner() {
            document.getElementById('api-status-banner').classList.remove('visible');
        }

        async function loadWeekData() {
            try {
                const res = await fetch('/api/week' + (window.getSeasonParam ? window.getSeasonParam() : ''));
                const data = await res.json();

                // Check if this is an error response with no data
                if (data.error && !data.managers) {
                    throw new Error(data.message || data.error);
                }

                weekData = data;

                // Check for API status flag (indicates cached data due to API outage)
                if (weekData._apiStatus) {
                    showApiBanner(weekData._apiStatus.message, weekData._apiStatus.lastRefresh);
                } else {
                    hideApiBanner();
                }

                document.getElementById('league-name').textContent = weekData.leagueName;
                document.getElementById('gw-subtitle').textContent = `Gameweek ${weekData.currentGW}`;

                // Build ticker HTML (now includes live indicator and updated timestamp)
                let tickerHtml = buildTickerHtml(weekData);

                let html = `
                    ${tickerHtml}
                    <div class="table-container"></div>
                `;

                document.getElementById('content').innerHTML = html;
                renderTable();

                // Scroll ticker to show latest events (right side)
                const tickerTrack = document.getElementById('ticker-track');
                if (tickerTrack) {
                    tickerTrack.scrollLeft = tickerTrack.scrollWidth;
                }

                // Check for URL params to auto-open modal (e.g., from losers page)
                await handleUrlParams();

                if (weekData.isLive) {
                    if (!refreshInterval) {
                        refreshInterval = setInterval(loadWeekData, 60000);
                    }
                } else if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            } catch (error) {
                // Try to get more info from the error response
                let errorData = null;
                try {
                    const res = await fetch('/api/week' + (window.getSeasonParam ? window.getSeasonParam() : ''));
                    errorData = await res.json();
                } catch (e) { /* ignore */ }

                // Show error with helpful message
                const banner = document.getElementById('api-status-banner');
                banner.classList.add('visible', 'error');
                const errorMessage = errorData?.message || error.message || 'Unable to load data';
                document.getElementById('api-status-message').textContent = errorMessage;

                // Build availability message
                let availabilityHtml = '';
                if (errorData?.nextKickoff?.availableFrom) {
                    const availableTime = new Date(errorData.nextKickoff.availableFrom);
                    const kickoffTime = new Date(errorData.nextKickoff.kickoff);
                    const now = new Date();

                    if (availableTime > now) {
                        const timeStr = availableTime.toLocaleString('en-GB', {
                            weekday: 'short',
                            day: 'numeric',
                            month: 'short',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        availabilityHtml = `
                            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0, 255, 135, 0.1); border-radius: 8px; border: 1px solid rgba(0, 255, 135, 0.3);">
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.25rem;">Live data available from</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent);">${timeStr}</div>
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">~15 minutes before first kickoff</div>
                            </div>
                        `;
                    } else {
                        availabilityHtml = `
                            <div style="margin-top: 1rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                                Data should be available soon. Try refreshing in a few minutes.
                            </div>
                        `;
                    }
                }

                const errorDiv = document.createElement('div');
                errorDiv.className = 'loading';
                errorDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem;">â³</div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${errorMessage}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">The FPL API is temporarily unavailable</div>
                        ${availabilityHtml}
                        <button onclick="loadWeekData()" style="margin-top: 1.5rem; padding: 0.6rem 1.5rem; background: var(--accent); color: var(--primary); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">Retry</button>
                    </div>
                `;
                document.getElementById('content').innerHTML = '';
                document.getElementById('content').appendChild(errorDiv);
            }
        }

        async function openManagerModal(entryId) {
            const manager = weekData.managers.find(m => m.entryId === entryId);
            if (!manager) return;

            // Initialize modal state
            currentModalEntryId = entryId;
            currentModalGW = weekData.currentGW;

            document.getElementById('modal-manager-name').textContent = manager.name;
            document.getElementById('modal-team-name').textContent = manager.team;
            document.getElementById('modal-points').textContent = manager.gwScore;
            document.getElementById('gw-label').textContent = `GW ${currentModalGW}`;
            document.getElementById('modal-body').innerHTML = '<div class="loading" style="padding: 2rem; color: #666;">Loading team...</div>';
            document.getElementById('modal-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';

            await loadModalData(entryId, currentModalGW);
        }

        async function navigateGW(direction) {
            if (!currentModalEntryId) return;

            const newGW = currentModalGW + direction;
            if (newGW < 1 || (currentTinkeringData?.navigation && newGW > currentTinkeringData.navigation.maxGW)) {
                return;
            }

            currentModalGW = newGW;
            document.getElementById('gw-label').textContent = `GW ${currentModalGW}`;
            document.getElementById('modal-body').innerHTML = '<div class="loading" style="padding: 2rem; color: #666;">Loading team...</div>';

            await loadModalData(currentModalEntryId, currentModalGW);
        }

        async function loadModalData(entryId, gw) {
            try {
                // Fetch picks and tinkering data in parallel
                const [picksRes, tinkeringRes] = await Promise.all([
                    fetch(`/api/manager/${entryId}/picks?gw=${gw}`),
                    fetch(`/api/manager/${entryId}/tinkering?gw=${gw}`)
                ]);

                if (!picksRes.ok) {
                    throw new Error(`Picks: HTTP ${picksRes.status}`);
                }
                if (!tinkeringRes.ok) {
                    throw new Error(`Tinkering: HTTP ${tinkeringRes.status}`);
                }

                currentPicksData = await picksRes.json();
                currentTinkeringData = await tinkeringRes.json();

                // Update points display (show bonus as +X if present)
                const pts = currentPicksData.basePoints ?? currentPicksData.calculatedPoints ?? currentPicksData.points;
                const bonus = currentPicksData.totalProvisionalBonus || 0;
                if (bonus > 0) {
                    document.getElementById('modal-points').innerHTML = `${pts}<span class="provisional-bonus" style="font-size: 0.5em; color: var(--success);">+${bonus}</span>`;
                } else {
                    document.getElementById('modal-points').textContent = currentPicksData.calculatedPoints || currentPicksData.points;
                }

                // Render pitch and tinkering bar
                renderPitchView(currentPicksData);

                // Update navigation buttons
                updateNavButtons();
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'loading';
                errorDiv.style.padding = '2rem';
                errorDiv.style.color = 'var(--danger)';
                errorDiv.textContent = 'Error: ' + error.message;
                document.getElementById('modal-body').innerHTML = '';
                document.getElementById('modal-body').appendChild(errorDiv);
            }
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('gw-prev');
            const nextBtn = document.getElementById('gw-next');

            if (currentTinkeringData?.navigation) {
                const nav = currentTinkeringData.navigation;
                prevBtn.disabled = currentModalGW <= 1;
                nextBtn.disabled = currentModalGW >= nav.maxGW;
            } else {
                prevBtn.disabled = currentModalGW <= 1;
                nextBtn.disabled = currentModalGW >= weekData.currentGW;
            }
        }

        function renderPlayerShirt(player) {
            const teamCode = player.teamCode || 1;
            // Use GK shirt for goalkeepers (positionId === 1)
            const shirtSuffix = player.positionId === 1 ? '_1' : '';
            const shirtUrl = `https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${teamCode}${shirtSuffix}-110.webp`;

            return `
                <div class="player-shirt">
                    <img src="${shirtUrl}" alt="${player.teamName}" onerror="this.src='https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_0-110.webp'">
                    ${player.isCaptain ? '<div class="captain-badge">C</div>' : ''}
                    ${player.isViceCaptain ? '<div class="vice-badge">V</div>' : ''}
                </div>
            `;
        }

        function getPointsDisplay(player, isBench = false) {
            const basePoints = player.totalPoints || player.points || 0;

            // If hasn't played yet, show opponent (for both starters and bench)
            if (player.playStatus === 'not_started') {
                return `<div class="player-points-pill not-played">${player.opponent || '-'}</div>`;
            }
            if (player.playStatus === 'not_played_yet') {
                return `<div class="player-points-pill not-played">${player.opponent || '-'}</div>`;
            }

            // Bench players (not subbed in) always show their actual points
            if (isBench) {
                return `<div class="player-points-pill">${basePoints}</div>`;
            }

            // Calculate effective points
            // Subbed-in players get x1 (no captain bonus), original starters use their multiplier
            let effectiveMultiplier = player.subIn ? 1 : (player.isCaptain ? 2 : player.multiplier);
            const pts = basePoints * effectiveMultiplier;

            // Show provisional bonus as separate indicator (base score +bonus)
            // Bonus points DO get captain multiplier
            if (player.provisionalBonus > 0) {
                const bonusWithMultiplier = player.provisionalBonus * effectiveMultiplier;
                return `<div class="player-points-pill" title="Base: ${pts}, Provisional bonus: +${bonusWithMultiplier} (BPS: ${player.bps})">${pts}<span class="provisional-bonus">+${bonusWithMultiplier}</span></div>`;
            }

            return `<div class="player-points-pill">${pts}</div>`;
        }

        // Icon configuration for player events
        const EVENT_ICONS = {
            'goals_scored': { icon: 'âš½', showCount: true },
            'own_goals': { icon: 'âš½', showCount: true, style: 'filter: hue-rotate(320deg) saturate(1.5);' },
            'assists': { icon: 'ðŸ‘Ÿ', showCount: true },
            'clean_sheets': { icon: 'ðŸ›¡ï¸', showCount: false },
            'defensive_contribution': { icon: 'ðŸ”’', showCount: false },
            'yellow_cards': { icon: 'ðŸŸ¨', showCount: false },
            'red_cards': { icon: 'ðŸŸ¥', showCount: false },
            'penalties_saved': { icon: 'ðŸ§¤', showCount: false },
            'penalties_missed': { icon: 'âŒ', showCount: false },
            'saves': { icon: 'ðŸ§¤', showCount: false }
        };

        function buildEventIcons(pointsBreakdown) {
            if (!pointsBreakdown) return '';

            // Check if player has red card (replaces yellow)
            const hasRed = pointsBreakdown.some(p => p.identifier === 'red_cards');

            const icons = [];
            const priorityOrder = ['goals_scored', 'own_goals', 'assists', 'clean_sheets', 'defensive_contribution', 'red_cards', 'yellow_cards', 'penalties_saved', 'penalties_missed', 'saves'];

            priorityOrder.forEach(type => {
                if (type === 'yellow_cards' && hasRed) return;

                const breakdown = pointsBreakdown.find(p => p.identifier === type);
                if (!breakdown) return;

                const config = EVENT_ICONS[type];
                if (!config) return;

                const count = typeof breakdown.value === 'number' ? breakdown.value : 1;
                const showNum = config.showCount && count > 1;
                const style = config.style || '';

                icons.push(`<span title="${breakdown.stat}" style="${style}">${config.icon}${showNum ? count : ''}</span>`);
            });

            return icons.join('');
        }

        function renderPlayer(player, isBench = false) {
            const subClass = player.subOut ? 'subbed-out' : (player.subIn ? 'subbed-in' : '');
            const playingClass = player.playStatus === 'playing' ? 'playing' : '';
            const finishedClass = (player.playStatus === 'played' || player.playStatus === 'benched') ? 'finished' : '';
            const eventsHtml = buildEventIcons(player.pointsBreakdown);

            return `
                <div class="player-card ${subClass} ${playingClass} ${finishedClass}"
                     data-player-id="${player.id}"
                     onmouseenter="showTooltip(event, ${player.id})"
                     onmouseleave="hideTooltip()"
                     onclick="handlePlayerClick(${player.id})">
                    ${renderPlayerShirt(player)}
                    <div class="player-name-box">
                        <span class="player-name">${player.name}</span>
                    </div>
                    ${getPointsDisplay(player, isBench)}
                    ${!isBench && eventsHtml ? `<div class="player-events">${eventsHtml}</div>` : ''}
                </div>
            `;
        }

        function renderPitchView(data) {
            // Separate starters and bench, account for auto-subs
            const effectiveStarters = data.players.filter(p => (!p.isBench && !p.subOut) || p.subIn);
            const effectiveBench = data.players.filter(p => (p.isBench && !p.subIn) || p.subOut);

            // Sort bench by original bench order
            effectiveBench.sort((a, b) => {
                const aOrder = a.isBench ? a.benchOrder : 99;
                const bOrder = b.isBench ? b.benchOrder : 99;
                return aOrder - bOrder;
            });

            // Group by position
            const gk = effectiveStarters.filter(p => p.positionId === 1);
            const def = effectiveStarters.filter(p => p.positionId === 2);
            const mid = effectiveStarters.filter(p => p.positionId === 3);
            const fwd = effectiveStarters.filter(p => p.positionId === 4);

            const chipText = data.activeChip ? ` - ${CHIP_NAMES[data.activeChip] || data.activeChip} Active` : '';

            // Auto-subs notification
            let autoSubsHtml = '';
            if (data.autoSubs && data.autoSubs.length > 0) {
                const subText = data.autoSubs.map(s => `${s.in.name} for ${s.out.name}`).join(', ');
                autoSubsHtml = `
                    <div class="auto-subs-bar">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                        Auto-sub: ${subText}
                    </div>
                `;
            }

            let html = `
                <div class="formation-bar">Formation: <strong>${data.formation}</strong>${chipText}</div>
                ${autoSubsHtml}
                <div class="pitch-container">
                    <div class="pitch-markings">
                        <div class="pitch-halfway"></div>
                        <div class="pitch-center"></div>
                        <div class="pitch-box-top"></div>
                        <div class="pitch-box-bottom"></div>
                    </div>
                    <div class="formation-row gk">${gk.map(p => renderPlayer(p)).join('')}</div>
                    <div class="formation-row">${def.map(p => renderPlayer(p)).join('')}</div>
                    <div class="formation-row">${mid.map(p => renderPlayer(p)).join('')}</div>
                    <div class="formation-row fwd">${fwd.map(p => renderPlayer(p)).join('')}</div>
                </div>
                <div class="bench-container">
                    <div class="bench-header">
                        <span class="bench-label">Substitutes</span>
                        <span class="bench-points">${data.pointsOnBench} pts</span>
                    </div>
                    <div class="bench-row">
                        ${effectiveBench.map((p, i) => `
                            <div class="bench-slot">
                                <div class="bench-position">${POSITION_LABELS[i] || ''}</div>
                                ${renderPlayer(p, true)}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${renderTinkeringBar()}
            `;

            document.getElementById('modal-body').innerHTML = html;
        }

        function renderTinkeringBar() {
            if (!currentTinkeringData) return '';

            // If tinkering not available (GW1 or error)
            if (!currentTinkeringData.available) {
                if (currentTinkeringData.reason === 'gw1') {
                    return `<div class="tinkering-unavailable">No tinkering data for GW1 (no previous team to compare)</div>`;
                }
                return '';
            }

            const { actualScore, hypotheticalScore, transferCost, netImpact, reason,
                    transfersIn, transfersOut, captainChange, lineupChanges } = currentTinkeringData;

            // Determine impact class
            let impactClass = 'neutral';
            if (netImpact > 0) impactClass = 'positive';
            else if (netImpact < 0) impactClass = 'negative';

            // Format impact display
            const impactDisplay = netImpact > 0 ? `+${netImpact}` : netImpact.toString();

            // Build chip badge if applicable
            let chipBadge = '';
            if (reason === 'freehit') chipBadge = '<span class="tinkering-badge freehit">FH</span>';
            else if (reason === 'wildcard') chipBadge = '<span class="tinkering-badge wildcard">WC</span>';

            // Build transfers in section with true impact
            let transfersInHtml = '';
            if (transfersIn && transfersIn.length > 0) {
                const totalImpact = transfersIn.reduce((sum, t) => sum + (t.impact || 0), 0);
                const impactClass = totalImpact > 0 ? 'positive' : (totalImpact < 0 ? 'negative' : 'neutral');
                const impactSign = totalImpact > 0 ? '+' : '';
                transfersInHtml = `
                    <div class="tinkering-section positive-section">
                        <div class="tinkering-section-title positive">Transfers In</div>
                        ${transfersIn.map(t => {
                            const ptsClass = (t.impact || 0) > 0 ? 'positive' : ((t.impact || 0) < 0 ? 'negative' : 'neutral');
                            const ptsSign = (t.impact || 0) > 0 ? '+' : '';
                            return `
                            <div class="tinkering-item">
                                <span>${t.player.name}${t.captained ? ' (C)' : ''}</span>
                                <span class="points ${ptsClass}">${ptsSign}${t.impact || 0} pts</span>
                            </div>
                        `}).join('')}
                        <div class="tinkering-section-total">
                            <span>Section Total</span>
                            <span class="points ${impactClass}">${impactSign}${totalImpact} pts</span>
                        </div>
                    </div>
                `;
            }

            // Build transfers out section with true impact
            let transfersOutHtml = '';
            if (transfersOut && transfersOut.length > 0) {
                const totalImpact = transfersOut.reduce((sum, t) => sum + (t.impact || 0), 0);
                const impactClass = totalImpact > 0 ? 'positive' : (totalImpact < 0 ? 'negative' : 'neutral');
                const impactSign = totalImpact > 0 ? '+' : '';
                transfersOutHtml = `
                    <div class="tinkering-section negative-section">
                        <div class="tinkering-section-title negative">Transfers Out</div>
                        ${transfersOut.map(t => {
                            // Show as negative since these are points you "lost"
                            const displayImpact = -(t.impact || 0);
                            const ptsClass = displayImpact > 0 ? 'positive' : (displayImpact < 0 ? 'negative' : 'neutral');
                            const ptsSign = displayImpact > 0 ? '+' : '';
                            return `
                            <div class="tinkering-item">
                                <span>${t.player.name}${t.wasCaptain ? ' (was C)' : ''}</span>
                                <span class="points ${ptsClass}">${ptsSign}${displayImpact} pts</span>
                            </div>
                        `}).join('')}
                        <div class="tinkering-section-total">
                            <span>Section Total</span>
                            <span class="points ${impactClass}">${-totalImpact > 0 ? '+' : ''}${-totalImpact} pts</span>
                        </div>
                    </div>
                `;
            }

            // Build captain change section
            let captainHtml = '';
            if (captainChange && captainChange.changed) {
                const capImpact = captainChange.impact;
                const capClass = capImpact > 0 ? 'positive' : (capImpact < 0 ? 'negative' : 'neutral');
                const sectionClass = capImpact > 0 ? 'positive-section' : (capImpact < 0 ? 'negative-section' : 'neutral-section');
                const capSign = capImpact > 0 ? '+' : '';
                captainHtml = `
                    <div class="tinkering-section ${sectionClass}">
                        <div class="tinkering-section-title ${capClass}">Captain Change</div>
                        <div class="tinkering-item">
                            <span>${captainChange.oldCaptain?.name} (${captainChange.oldCaptain?.points} pts) &rarr; ${captainChange.newCaptain?.name} (${captainChange.newCaptain?.points} pts)</span>
                        </div>
                        <div class="tinkering-section-total">
                            <span>Impact</span>
                            <span class="points ${capClass}">${capSign}${capImpact} pts</span>
                        </div>
                    </div>
                `;
            }

            // Build lineup changes section with true impact
            let lineupHtml = '';
            const hasLineupChanges = (lineupChanges?.movedToStarting?.length > 0) || (lineupChanges?.movedToBench?.length > 0);
            if (hasLineupChanges) {
                // Sum impacts (they already have the correct sign from server calculation)
                const startedImpact = lineupChanges.movedToStarting?.reduce((sum, p) => sum + (p.impact || 0), 0) || 0;
                const benchedImpact = lineupChanges.movedToBench?.reduce((sum, p) => sum + (p.impact || 0), 0) || 0;
                const lineupImpact = startedImpact + benchedImpact;
                const lineupClass = lineupImpact > 0 ? 'positive' : (lineupImpact < 0 ? 'negative' : 'neutral');
                const sectionClass = lineupImpact > 0 ? 'positive-section' : (lineupImpact < 0 ? 'negative-section' : 'neutral-section');

                let lineupItems = '';
                if (lineupChanges.movedToStarting?.length > 0) {
                    lineupItems += lineupChanges.movedToStarting.map(p => {
                        const impact = p.impact || 0;
                        const ptsClass = impact > 0 ? 'positive' : (impact < 0 ? 'negative' : 'neutral');
                        const ptsSign = impact > 0 ? '+' : '';
                        return `
                        <div class="tinkering-item">
                            <span>Started ${p.name}</span>
                            <span class="points ${ptsClass}">${ptsSign}${impact} pts</span>
                        </div>
                    `}).join('');
                }
                if (lineupChanges.movedToBench?.length > 0) {
                    lineupItems += lineupChanges.movedToBench.map(p => {
                        const impact = p.impact || 0;
                        const ptsClass = impact > 0 ? 'positive' : (impact < 0 ? 'negative' : 'neutral');
                        const ptsSign = impact > 0 ? '+' : '';
                        return `
                        <div class="tinkering-item">
                            <span>Benched ${p.name}</span>
                            <span class="points ${ptsClass}">${ptsSign}${impact} pts</span>
                        </div>
                    `}).join('');
                }
                const lineupSign = lineupImpact > 0 ? '+' : '';
                lineupHtml = `
                    <div class="tinkering-section ${sectionClass}">
                        <div class="tinkering-section-title">Lineup Changes</div>
                        ${lineupItems}
                        <div class="tinkering-section-total">
                            <span>Impact</span>
                            <span class="points ${lineupClass}">${lineupSign}${lineupImpact} pts</span>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="tinkering-bar" onclick="toggleTinkeringBar(this)">
                    <div class="tinkering-header">
                        <div class="tinkering-title">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>
                            Tinkering Impact${chipBadge}
                        </div>
                        <div>
                            <span class="tinkering-impact ${impactClass}">${impactDisplay} pts</span>
                            <span class="tinkering-toggle">&#9660;</span>
                        </div>
                    </div>
                    <div class="tinkering-details">
                        <div class="tinkering-summary">
                            <div class="tinkering-row">
                                <span>If you kept last week's team:</span>
                                <span>${hypotheticalScore} pts</span>
                            </div>
                            <div class="tinkering-row">
                                <span>Your actual score:</span>
                                <span>${actualScore} pts</span>
                            </div>
                            ${transferCost > 0 ? `
                            <div class="tinkering-row">
                                <span>Transfer hits:</span>
                                <span class="tinkering-impact negative">-${transferCost} pts</span>
                            </div>
                            ` : ''}
                            <div class="tinkering-row total">
                                <span>NET BENEFIT:</span>
                                <span class="tinkering-impact ${impactClass}">${impactDisplay} pts</span>
                            </div>
                        </div>
                        ${transfersInHtml}
                        ${transfersOutHtml}
                        ${captainHtml}
                        ${lineupHtml}
                    </div>
                </div>
            `;
        }

        function toggleTinkeringBar(element) {
            element.classList.toggle('expanded');
        }

        function showTooltip(event, playerId) {
            if (isMobile) return;
            const player = currentPicksData?.players.find(p => p.id === playerId);
            if (!player) return;

            const breakdown = player.pointsBreakdown || [];
            const tooltip = document.getElementById('tooltip');

            let statsHtml = `<div class="tooltip-header">${player.fullName || player.name}</div>`;

            if (breakdown.length === 0) {
                statsHtml += `<div class="tooltip-row"><span class="stat">No points yet</span><span></span><span></span></div>`;
            } else {
                breakdown.forEach(item => {
                    const ptsColor = item.points < 0 ? 'color: #e74c3c;' : 'color: #4ade80;';
                    const icon = item.icon || '';
                    statsHtml += `
                        <div class="tooltip-row">
                            <span class="stat">${icon} ${item.stat}</span>
                            <span class="value">${item.value}</span>
                            <span class="pts" style="${ptsColor}">${item.points}</span>
                        </div>`;
                });
            }

            statsHtml += `
                <div class="tooltip-row total">
                    <span class="stat">Total</span>
                    <span></span>
                    <span class="pts">${player.totalPoints || player.points}</span>
                </div>`;

            tooltip.innerHTML = statsHtml;
            tooltip.style.left = `${event.clientX + 10}px`;
            tooltip.style.top = `${event.clientY + 10}px`;
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        function handlePlayerClick(playerId) {
            if (!isMobile) return;
            showPlayerSheet(playerId);
        }

        function showPlayerSheet(playerId) {
            const player = currentPicksData?.players.find(p => p.id === playerId);
            if (!player) return;

            const breakdown = player.pointsBreakdown || [];
            const colors = player.teamColors || { primary: '#333', secondary: '#fff' };
            const basePoints = player.totalPoints || player.points || 0;
            // Subbed-in players get x1, captains x2, otherwise use multiplier
            const effectiveMultiplier = player.subIn ? 1 : (player.isCaptain ? 2 : player.multiplier);
            const pts = basePoints * effectiveMultiplier;

            let breakdownHtml = '';
            if (breakdown.length === 0) {
                breakdownHtml = '<div class="breakdown-row"><span>No points yet</span></div>';
            } else {
                breakdown.forEach(item => {
                    const ptsClass = item.points < 0 ? 'negative' : '';
                    const icon = item.icon || '';
                    breakdownHtml += `
                        <div class="breakdown-row">
                            <span class="breakdown-stat">${icon} ${item.stat}</span>
                            <span class="breakdown-value">${item.value}</span>
                            <span class="breakdown-pts ${ptsClass}">${item.points} pts</span>
                        </div>
                    `;
                });
            }

            const teamCode = player.teamCode || 1;
            const shirtSuffix = player.positionId === 1 ? '_1' : '';
            const shirtUrl = `https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${teamCode}${shirtSuffix}-110.webp`;

            let html = `
                <div class="player-sheet-header">
                    <div class="player-sheet-badge">
                        <img src="${shirtUrl}" alt="${player.teamName}">
                    </div>
                    <div class="player-sheet-info">
                        <h3>${player.fullName || player.name}</h3>
                        <p>${player.teamName} - ${player.position}</p>
                    </div>
                    <div class="player-sheet-points">${pts}</div>
                </div>
                <div class="points-breakdown">
                    <div class="breakdown-header">
                        <span>Statistic</span>
                        <span style="text-align:center">Value</span>
                        <span style="text-align:right">Points</span>
                    </div>
                    ${breakdownHtml}
                    <div class="breakdown-total">
                        <span>Total</span>
                        <span></span>
                        <span>${player.totalPoints || player.points} pts</span>
                    </div>
                </div>
            `;

            document.getElementById('player-sheet').innerHTML = html;
            document.getElementById('sheet-overlay').classList.add('visible');
            document.getElementById('player-sheet').classList.add('visible');
        }

        function closePlayerSheet() {
            document.getElementById('sheet-overlay').classList.remove('visible');
            document.getElementById('player-sheet').classList.remove('visible');
        }

        // Fixtures Modal Functions
        function openFixturesModal() {
            if (!weekData?.fixtures) return;

            const fixtures = weekData.fixtures;
            document.getElementById('fixtures-modal-title').textContent = `GW ${weekData.currentGW} Fixtures`;

            let html = fixtures.map(f => {
                let statusClass = '';
                let statusBadge = '';

                if (f.started && !f.finished) {
                    statusClass = 'live';
                    statusBadge = `<span class="fixture-status live">${f.minutes || 0}'</span>`;
                } else if (f.finished) {
                    statusClass = 'finished';
                    statusBadge = `<span class="fixture-status ft">FT</span>`;
                }

                const scoreOrTime = f.started
                    ? `<div class="fixture-score">${f.homeScore ?? 0} - ${f.awayScore ?? 0}</div>`
                    : `<div class="fixture-kickoff">${formatKickoffTime(f.kickoff)}</div>`;

                return `
                    <div class="fixture-item ${statusClass}" onclick="openMatchModal(${f.id}); closeFixturesModal();">
                        <span class="fixture-team home">${f.home}</span>
                        ${scoreOrTime}
                        <span class="fixture-team away">${f.away}</span>
                        ${statusBadge}
                    </div>
                `;
            }).join('');

            document.getElementById('fixtures-modal-body').innerHTML = html;
            document.getElementById('fixtures-modal-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFixturesModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('fixtures-modal-overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Match Modal Functions
        async function openMatchModal(fixtureId) {
            const fixture = weekData?.fixtures?.find(f => f.id === fixtureId);
            if (!fixture) return;

            const score = fixture.started
                ? `<span class="match-score">${fixture.homeScore ?? 0} - ${fixture.awayScore ?? 0}</span>`
                : 'vs';
            document.getElementById('match-teams').innerHTML = `${fixture.home} ${score} ${fixture.away}`;

            let status = '';
            if (fixture.finished) status = 'Full Time';
            else if (fixture.started) status = `${fixture.minutes || 0}\'`;
            else status = formatKickoffTime(fixture.kickoff);
            document.getElementById('match-status').textContent = status;

            document.getElementById('match-modal-body').innerHTML = '<div class="loading" style="text-align: center; padding: 2rem;">Loading match data...</div>';
            document.getElementById('match-modal-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Fetch match stats from API
            try {
                const res = await fetch(`/api/fixture/${fixtureId}/stats`);
                const data = await res.json();
                renderMatchStats(data, fixture);
            } catch (e) {
                document.getElementById('match-modal-body').innerHTML = `<div class="loading" style="color: var(--danger);">Failed to load match data</div>`;
            }
        }

        function closeMatchModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('match-modal-overlay').classList.remove('active');
            document.body.style.overflow = '';
            currentMatchStatsData = null;
        }

        // Event impact tracking
        function showEventImpact(eventIdx) {
            // Hide bonus popup if visible
            hideBonusPopup();

            // Toggle selection
            if (selectedEventIdx === eventIdx) {
                clearEventImpact();
                return;
            }

            selectedEventIdx = eventIdx;

            // Update ticker event styling
            document.querySelectorAll('.ticker-event').forEach((el, i) => {
                el.classList.toggle('selected', i === eventIdx);
            });

            // Re-render table with impact badges
            renderTable();
        }

        function clearEventImpact() {
            selectedEventIdx = null;
            selectedChangeIdx = null;
            selectedChronoIdx = null;
            hideBonusPopup();
            document.querySelectorAll('.ticker-event').forEach(el => {
                el.classList.remove('selected');
            });

            renderTable();
        }

        // Bonus popup functions
        function showBonusPopup(clickEvent, eventIdx) {
            clickEvent.stopPropagation();

            const event = weekData?.liveEvents?.[eventIdx];
            if (!event || !event.isBonus) return;

            // Select this event for impact display
            selectedEventIdx = eventIdx;
            document.querySelectorAll('.ticker-event').forEach((el, i) => {
                el.classList.toggle('selected', i === eventIdx);
            });

            // Build popup content
            let html = `<div class="bonus-popup-header">${event.match} - Bonus Points</div>`;

            if (event.bonusPlayers && event.bonusPlayers.length > 0) {
                html += event.bonusPlayers.map(p => `
                    <div class="bonus-player-row">
                        <span class="name">${p.name}<span class="bps">${p.bps} BPS</span></span>
                        <span class="bonus-pts">+${p.bonus}</span>
                    </div>
                `).join('');
            }

            if (event.nearMissPlayers && event.nearMissPlayers.length > 0) {
                html += `<div class="bonus-section-label">Just outside:</div>`;
                html += event.nearMissPlayers.map(p => `
                    <div class="bonus-player-row near-miss">
                        <span class="name">${p.name}<span class="bps">${p.bps} BPS</span></span>
                        <span class="bonus-pts">-</span>
                    </div>
                `).join('');
            }

            const popup = document.getElementById('bonus-popup');
            popup.innerHTML = html;

            // Position popup near click
            const rect = clickEvent.target.closest('.ticker-event').getBoundingClientRect();
            popup.style.left = `${Math.min(rect.left, window.innerWidth - 260)}px`;
            popup.style.top = `${rect.bottom + 8}px`;
            popup.classList.add('visible');

            // Re-render table with impact
            renderTable();
        }

        function hideBonusPopup() {
            const popup = document.getElementById('bonus-popup');
            if (popup) popup.classList.remove('visible');
        }

        // Close bonus popup when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.bonus-popup') && !e.target.closest('.ticker-event.bonus')) {
                hideBonusPopup();
            }
        });

        // Change event handlers
        function showBonusChangePopup(clickEvent, changeIdx) {
            clickEvent.stopPropagation();
            hideBonusPopup();

            const changeEvent = weekData?.changeEvents?.[changeIdx];
            if (!changeEvent || changeEvent.type !== 'bonus_change') return;

            selectedChangeIdx = changeIdx;
            selectedEventIdx = null; // Clear regular event selection

            // Build popup content showing changes
            let html = `<div class="bonus-popup-header">${changeEvent.match} - Bonus Changed${changeEvent.minute ? ` (${changeEvent.minute}')` : ''}</div>`;

            changeEvent.changes.forEach(c => {
                const arrow = c.impact > 0 ? 'â–²' : (c.impact < 0 ? 'â–¼' : '');
                const impactClass = c.impact > 0 ? 'positive' : (c.impact < 0 ? 'negative' : '');
                const fromTo = c.from > 0 || c.to > 0 ? ` (${c.from}â†’${c.to})` : '';
                html += `
                    <div class="bonus-player-row ${impactClass}">
                        <span class="name">${arrow} ${c.player}${fromTo}</span>
                        <span class="bonus-pts" style="color: ${c.impact > 0 ? 'var(--accent)' : 'var(--danger)'}">${c.impact > 0 ? '+' : ''}${c.impact}</span>
                    </div>
                `;
            });

            const popup = document.getElementById('bonus-popup');
            popup.innerHTML = html;

            const rect = clickEvent.target.closest('.ticker-event').getBoundingClientRect();
            popup.style.left = `${Math.min(rect.left, window.innerWidth - 260)}px`;
            popup.style.top = `${rect.bottom + 8}px`;
            popup.classList.add('visible');

            // Show impact on managers
            renderTableWithChangeImpact(changeEvent);
        }

        function showCSLostImpact(changeIdx) {
            hideBonusPopup();

            const changeEvent = weekData?.changeEvents?.[changeIdx];
            if (!changeEvent || changeEvent.type !== 'cs_lost') return;

            selectedChangeIdx = changeIdx;
            selectedEventIdx = null;

            // Show impact on managers who have defenders from this team
            renderTableWithChangeImpact(changeEvent);
        }

        function showDefconImpact(changeIdx) {
            hideBonusPopup();

            const changeEvent = weekData?.changeEvents?.[changeIdx];
            if (!changeEvent || changeEvent.type !== 'defcon_gained') return;

            selectedChangeIdx = changeIdx;
            selectedEventIdx = null;

            // Show impact on managers who own this player
            renderTableWithChangeImpact(changeEvent);
        }

        // Chronological event handlers
        function showChronoEventImpact(chronoIdx) {
            hideBonusPopup();

            const chronoEvent = weekData?.chronologicalEvents?.[chronoIdx];
            if (!chronoEvent) return;

            // Toggle selection
            if (selectedChronoIdx === chronoIdx) {
                clearChronoEventImpact();
                return;
            }

            selectedChronoIdx = chronoIdx;
            selectedEventIdx = null;
            selectedChangeIdx = null;

            // Update ticker event styling
            document.querySelectorAll('.ticker-event').forEach(el => {
                const idx = el.getAttribute('data-chrono-idx');
                el.classList.toggle('selected', idx !== null && parseInt(idx) === chronoIdx);
            });

            // Re-render table with impact
            renderTableWithChronoImpact(chronoEvent);
        }

        function showChronoBonusPopup(clickEvent, chronoIdx) {
            clickEvent.stopPropagation();

            // Toggle: if clicking the same event, close popup
            if (selectedChronoIdx === chronoIdx) {
                clearChronoEventImpact();
                return;
            }

            hideBonusPopup();

            const chronoEvent = weekData?.chronologicalEvents?.[chronoIdx];
            if (!chronoEvent || chronoEvent.type !== 'bonus_change') return;

            selectedChronoIdx = chronoIdx;
            selectedEventIdx = null;
            selectedChangeIdx = null;

            // Build popup content showing changes
            let html = `<div class="bonus-popup-header">${chronoEvent.match} - Bonus Changed</div>`;

            (chronoEvent.changes || []).forEach(c => {
                const arrow = c.impact > 0 ? 'â–²' : (c.impact < 0 ? 'â–¼' : '');
                const impactClass = c.impact > 0 ? 'positive' : (c.impact < 0 ? 'negative' : '');
                const fromTo = c.from > 0 || c.to > 0 ? ` (${c.from}â†’${c.to})` : '';
                html += `
                    <div class="bonus-player-row ${impactClass}">
                        <span class="name">${arrow} ${c.player}${fromTo}</span>
                        <span class="bonus-pts" style="color: ${c.impact > 0 ? 'var(--accent)' : 'var(--danger)'}">${c.impact > 0 ? '+' : ''}${c.impact}</span>
                    </div>
                `;
            });

            const popup = document.getElementById('bonus-popup');
            popup.innerHTML = html;

            const rect = clickEvent.target.closest('.ticker-event').getBoundingClientRect();
            popup.style.left = `${Math.min(rect.left, window.innerWidth - 260)}px`;
            popup.style.top = `${rect.bottom + 8}px`;
            popup.classList.add('visible');

            // Update ticker event styling
            document.querySelectorAll('.ticker-event').forEach(el => {
                const idx = el.getAttribute('data-chrono-idx');
                el.classList.toggle('selected', idx !== null && parseInt(idx) === chronoIdx);
            });

            // Show impact on managers
            renderTableWithChronoImpact(chronoEvent);
        }

        function clearChronoEventImpact() {
            selectedChronoIdx = null;
            hideBonusPopup();
            document.querySelectorAll('.ticker-event').forEach(el => {
                el.classList.remove('selected');
            });

            renderTable();
        }

        function showTeamEventPopup(clickEvent, chronoIdx) {
            clickEvent.stopPropagation();

            // Toggle: if clicking the same event, close popup
            if (selectedChronoIdx === chronoIdx) {
                clearChronoEventImpact();
                return;
            }

            hideBonusPopup();

            const chronoEvent = weekData?.chronologicalEvents?.[chronoIdx];
            if (!chronoEvent || (chronoEvent.type !== 'team_clean_sheet' && chronoEvent.type !== 'team_goals_conceded')) return;

            selectedChronoIdx = chronoIdx;
            selectedEventIdx = null;
            selectedChangeIdx = null;

            // Build popup content showing affected players
            const eventLabel = chronoEvent.type === 'team_clean_sheet' ? 'Clean Sheet' : 'Goals Conceded';
            let html = `<div class="bonus-popup-header">${chronoEvent.team} - ${eventLabel}</div>`;

            (chronoEvent.affectedPlayers || []).forEach(p => {
                const pointsClass = p.points >= 0 ? 'positive' : 'negative';
                const pointsDisplay = p.points >= 0 ? `+${p.points}` : `${p.points}`;
                html += `
                    <div class="bonus-player-row ${pointsClass}">
                        <span class="name">${p.player}</span>
                        <span class="bonus-pts" style="color: ${p.points >= 0 ? 'var(--accent)' : 'var(--danger)'}">${pointsDisplay}</span>
                    </div>
                `;
            });

            const popup = document.getElementById('bonus-popup');
            popup.innerHTML = html;

            const rect = clickEvent.target.closest('.ticker-event').getBoundingClientRect();
            popup.style.left = `${Math.min(rect.left, window.innerWidth - 260)}px`;
            popup.style.top = `${rect.bottom + 8}px`;
            popup.classList.add('visible');

            // Update ticker event styling
            document.querySelectorAll('.ticker-event').forEach(el => {
                const idx = el.getAttribute('data-chrono-idx');
                el.classList.toggle('selected', idx !== null && parseInt(idx) === chronoIdx);
            });

            // Show impact on managers
            renderTableWithChronoImpact(chronoEvent);
        }

        function renderTableWithChronoImpact(chronoEvent) {
            // Re-render table but use chrono event for impact calculation
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable ${sortClass('gwRank')}" onclick="sortTable('gwRank')">#</th>
                            <th class="col-manager sortable ${sortClass('manager')}" onclick="sortTable('manager')">Manager</th>
                            <th class="num sortable ${sortClass('overallPoints')}" onclick="sortTable('overallPoints')">Overall</th>
                            <th class="sortable ${sortClass('captain')}" onclick="sortTable('captain')">Captain</th>
                            <th class="num sortable ${sortClass('gwScore')}" onclick="sortTable('gwScore')">Pts</th>
                            <th class="num sortable ${sortClass('benchPoints')}" onclick="sortTable('benchPoints')">Bench</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            weekData.managers.forEach(m => {
                const rankClass = m.gwRank <= 3 ? `rank-${m.gwRank}` : '';

                let pills = [];
                if (m.activeChip) {
                    pills.push(`<span class="info-pill chip-pill ${m.activeChip}">${CHIP_NAMES[m.activeChip]}</span>`);
                }
                if (m.playersLeft > 0) {
                    pills.push(`<span class="info-pill left-pill">${m.playersLeft} left</span>`);
                }
                const pillsHtml = pills.length > 0 ? `<div class="manager-pills">${pills.join('')}</div>` : '';

                // Calculate impact from chrono event
                const impact = getChronoEventImpactForManager(m, chronoEvent);
                let impactHtml = '';
                if (impact !== null && impact !== 0) {
                    const isPositive = impact >= 0;
                    const impactClass = isPositive ? 'positive' : 'negative';
                    const arrow = isPositive ? 'â–²' : 'â–¼';
                    impactHtml = `<span class="event-impact ${impactClass}"><span class="arrow">${arrow}</span>${Math.abs(impact)}</span>`;
                }

                html += `
                    <tr class="clickable" onclick="openManagerModal(${m.entryId})">
                        <td class="rank-cell ${rankClass}">${m.gwRank}</td>
                        <td class="col-manager">
                            <strong>${m.name}</strong>
                            <div class="team-name">${m.team}</div>
                            ${pillsHtml}
                        </td>
                        <td class="num">${m.overallPoints || 0}</td>
                        <td class="captain-cell">
                            ${m.captainName || '-'}
                            ${m.viceCaptainName ? `<div class="vice-captain">${m.viceCaptainName}</div>` : ''}
                        </td>
                        <td class="num"><span class="badge badge-success">${m.gwScore}</span>${impactHtml}</td>
                        <td class="num">${m.benchPoints}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.querySelector('.table-container').innerHTML = html;
        }

        function getChronoEventImpactForManager(manager, event) {
            if (!event) return null;

            const starting11 = manager.starting11 || [];

            // For bonus changes, check if manager owns any affected players
            if (event.type === 'bonus_change' && event.changes) {
                let totalImpact = 0;
                event.changes.forEach(c => {
                    if (starting11.includes(c.elementId)) {
                        // Check if captain
                        const multiplier = manager.captainId === c.elementId ? 2 : 1;
                        totalImpact += c.impact * multiplier;
                    }
                });
                return totalImpact;
            }

            // For team events (clean sheets and goals conceded grouped by team)
            if ((event.type === 'team_clean_sheet' || event.type === 'team_goals_conceded') && event.affectedPlayers) {
                let totalImpact = 0;
                event.affectedPlayers.forEach(p => {
                    if (starting11.includes(p.elementId)) {
                        // Check if captain
                        const multiplier = manager.captainId === p.elementId ? 2 : 1;
                        totalImpact += p.points * multiplier;
                    }
                });
                return totalImpact;
            }

            // For player events, check if manager owns this player
            if (event.elementId) {
                if (starting11.includes(event.elementId)) {
                    const multiplier = manager.captainId === event.elementId ? 2 : 1;
                    return event.points * multiplier;
                }
            }

            return null;
        }

        function renderTableWithChangeImpact(changeEvent) {
            // Re-render table but use change event for impact calculation
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable ${sortClass('gwRank')}" onclick="sortTable('gwRank')">#</th>
                            <th class="col-manager sortable ${sortClass('manager')}" onclick="sortTable('manager')">Manager</th>
                            <th class="num sortable ${sortClass('overallPoints')}" onclick="sortTable('overallPoints')">Overall</th>
                            <th class="sortable ${sortClass('captain')}" onclick="sortTable('captain')">Captain</th>
                            <th class="num sortable ${sortClass('gwScore')}" onclick="sortTable('gwScore')">Pts</th>
                            <th class="num sortable ${sortClass('benchPoints')}" onclick="sortTable('benchPoints')">Bench</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            weekData.managers.forEach(m => {
                const rankClass = m.gwRank <= 3 ? `rank-${m.gwRank}` : '';

                let pills = [];
                if (m.activeChip) {
                    pills.push(`<span class="info-pill chip-pill ${m.activeChip}">${CHIP_NAMES[m.activeChip]}</span>`);
                }
                if (m.playersLeft > 0) {
                    pills.push(`<span class="info-pill left-pill">${m.playersLeft} left</span>`);
                }
                const pillsHtml = pills.length > 0 ? `<div class="manager-pills">${pills.join('')}</div>` : '';

                // Calculate impact from change event
                const impact = getChangeEventImpactForManager(m, changeEvent);
                let impactHtml = '';
                if (impact !== null && impact !== 0) {
                    const isPositive = impact >= 0;
                    const impactClass = isPositive ? 'positive' : 'negative';
                    const arrow = isPositive ? 'â–²' : 'â–¼';
                    impactHtml = `<span class="event-impact ${impactClass}"><span class="arrow">${arrow}</span>${Math.abs(impact)}</span>`;
                }

                html += `
                    <tr class="clickable" onclick="openManagerModal(${m.entryId})">
                        <td class="rank-cell ${rankClass}">${m.gwRank}</td>
                        <td class="col-manager">
                            <strong>${m.name}</strong>
                            <div class="team-name">${m.team}</div>
                            ${pillsHtml}
                        </td>
                        <td class="num">${m.overallPoints || 0}</td>
                        <td class="captain-cell">
                            ${m.captainName || '-'}
                            ${m.viceCaptainName ? `<div class="vice-captain">${m.viceCaptainName}</div>` : ''}
                        </td>
                        <td class="num"><span class="badge badge-success">${m.gwScore}</span>${impactHtml}</td>
                        <td class="num">${m.benchPoints}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.querySelector('.table-container').innerHTML = html;
        }

        function getChangeEventImpactForManager(manager, changeEvent) {
            if (!changeEvent || !manager.starting11) return null;

            if (changeEvent.type === 'bonus_change') {
                let totalImpact = 0;
                changeEvent.changes.forEach(c => {
                    if (manager.starting11.includes(c.elementId)) {
                        let multiplier = 1;
                        if (manager.captainId === c.elementId) {
                            multiplier = manager.activeChip === '3xc' ? 3 : 2;
                        }
                        totalImpact += c.impact * multiplier;
                    }
                });
                return totalImpact !== 0 ? totalImpact : null;
            }

            if (changeEvent.type === 'cs_lost') {
                if (manager.playerTeamMap && manager.defenderIds) {
                    const defendersFromTeam = manager.defenderIds.filter(pid =>
                        manager.playerTeamMap[pid] === changeEvent.teamId && manager.starting11.includes(pid)
                    );
                    if (defendersFromTeam.length > 0) {
                        return changeEvent.points * defendersFromTeam.length; // -4 per defender
                    }
                }
                return null;
            }

            if (changeEvent.type === 'defcon_gained') {
                if (manager.starting11.includes(changeEvent.elementId)) {
                    let multiplier = 1;
                    if (manager.captainId === changeEvent.elementId) {
                        multiplier = manager.activeChip === '3xc' ? 3 : 2;
                    }
                    return changeEvent.points * multiplier;
                }
                return null;
            }

            return null;
        }

        function getEventImpactForManager(manager) {
            if (selectedEventIdx === null || !weekData?.liveEvents) return null;

            const event = weekData.liveEvents[selectedEventIdx];
            if (!event || !manager.starting11) return null;

            // Handle bonus events - sum up bonus for all owned players
            if (event.isBonus && event.bonusPlayers) {
                let totalBonus = 0;
                event.bonusPlayers.forEach(bp => {
                    if (manager.starting11.includes(bp.elementId)) {
                        let multiplier = 1;
                        if (manager.captainId === bp.elementId) {
                            multiplier = manager.activeChip === '3xc' ? 3 : 2;
                        }
                        totalBonus += bp.bonus * multiplier;
                    }
                });
                return totalBonus > 0 ? totalBonus : null;
            }

            // Handle team events (clean_sheet, goals_conceded)
            if (event.isTeamEvent && event.teamId) {
                if (manager.playerTeamMap && manager.defenderIds) {
                    // Count how many GK/DEF the manager has from this team in starting 11
                    const defendersFromTeam = manager.defenderIds.filter(pid =>
                        manager.playerTeamMap[pid] === event.teamId && manager.starting11.includes(pid)
                    );

                    if (defendersFromTeam.length > 0) {
                        // Clean sheet: 4 pts per GK/DEF
                        // Goals conceded: points is already negative (-1 per 2 goals)
                        return event.points * defendersFromTeam.length;
                    }
                }
                return null;
            }

            // Regular player events - check if manager has this player in starting 11
            if (!manager.starting11.includes(event.elementId)) return null;

            // Calculate points (doubled for captain, tripled for TC)
            let multiplier = 1;
            if (manager.captainId === event.elementId) {
                multiplier = manager.activeChip === '3xc' ? 3 : 2;
            }

            return event.points * multiplier;
        }

        function showMatchPlayerSheet(playerId) {
            if (!currentMatchStatsData) return;

            // Find player in home or away teams
            const allPlayers = [
                ...(currentMatchStatsData.home?.starters || []),
                ...(currentMatchStatsData.home?.subs || []),
                ...(currentMatchStatsData.away?.starters || []),
                ...(currentMatchStatsData.away?.subs || [])
            ];
            const player = allPlayers.find(p => p.id === playerId);
            if (!player) return;

            const breakdown = player.pointsBreakdown || [];
            const basePoints = player.points || 0;

            let breakdownHtml = '';
            if (breakdown.length === 0) {
                breakdownHtml = '<div class="breakdown-row"><span>No points yet</span></div>';
            } else {
                breakdown.forEach(item => {
                    const ptsClass = item.points < 0 ? 'negative' : '';
                    const icon = item.icon || '';
                    breakdownHtml += `
                        <div class="breakdown-row">
                            <span class="breakdown-stat">${icon} ${item.stat}</span>
                            <span class="breakdown-value">${item.value}</span>
                            <span class="breakdown-pts ${ptsClass}">${item.points} pts</span>
                        </div>
                    `;
                });
            }

            const teamCode = player.teamCode || 1;
            const shirtSuffix = player.positionId === 1 ? '_1' : '';
            const shirtUrl = `https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${teamCode}${shirtSuffix}-110.webp`;

            let html = `
                <div class="player-sheet-header">
                    <div class="player-sheet-badge">
                        <img src="${shirtUrl}" alt="${player.teamName}">
                    </div>
                    <div class="player-sheet-info">
                        <h3>${player.fullName || player.name}</h3>
                        <p>${player.teamName} - ${player.position}</p>
                    </div>
                    <div class="player-sheet-points">${basePoints}</div>
                </div>
                <div class="points-breakdown">
                    <div class="breakdown-header">
                        <span>Statistic</span>
                        <span style="text-align:center">Value</span>
                        <span style="text-align:right">Points</span>
                    </div>
                    ${breakdownHtml}
                    <div class="breakdown-total">
                        <span>Total</span>
                        <span></span>
                        <span>${basePoints} pts</span>
                    </div>
                </div>
            `;

            document.getElementById('player-sheet').innerHTML = html;
            document.getElementById('sheet-overlay').classList.add('visible');
            document.getElementById('player-sheet').classList.add('visible');
        }

        function renderMatchStats(data, fixture) {
            if (!data || data.error) {
                document.getElementById('match-modal-body').innerHTML = `<div class="loading">${data?.error || 'No data available'}</div>`;
                return;
            }

            // Store data for player click handler
            currentMatchStatsData = data;

            // Extract starters and subs from new data structure
            const homeStarters = data.home?.starters || [];
            const homeSubs = data.home?.subs || [];
            const awayStarters = data.away?.starters || [];
            const awaySubs = data.away?.subs || [];

            const homePlayers = [...homeStarters, ...homeSubs];
            const awayPlayers = [...awayStarters, ...awaySubs];
            const allPlayers = [...homePlayers, ...awayPlayers];

            // Helper to render player icons with overlay count badge
            const renderIcons = (p) => {
                let icons = '';
                if (p.cleanSheet) icons += `<span class="player-icon cs" title="Clean Sheet">ðŸ›¡ï¸</span>`;
                if (p.goals) {
                    icons += `<span class="player-icon goal" title="${p.goals} goal${p.goals > 1 ? 's' : ''}">âš½${p.goals > 1 ? `<span class="icon-count">${p.goals}</span>` : ''}</span>`;
                }
                if (p.assists) {
                    icons += `<span class="player-icon assist" title="${p.assists} assist${p.assists > 1 ? 's' : ''}">ðŸ‘Ÿ${p.assists > 1 ? `<span class="icon-count">${p.assists}</span>` : ''}</span>`;
                }
                if (p.yellowCard) icons += `<span class="player-icon yellow" title="Yellow Card">ðŸŸ¨</span>`;
                if (p.redCard) icons += `<span class="player-icon red" title="Red Card">ðŸŸ¥</span>`;
                return icons;
            };

            // Render home player row: Name+icons left aligned, score on right
            const renderHomePlayerRow = (p) => {
                if (!p) return '<div class="player-row-sbs" style="visibility: hidden;"></div>';
                const ptsClass = p.points > 0 ? 'positive' : (p.points < 0 ? 'negative' : 'zero');
                const icons = renderIcons(p);
                return `
                    <div class="player-row-sbs clickable" onclick="showMatchPlayerSheet(${p.id})">
                        <div class="player-name-group">
                            <span class="player-name">${p.name}</span>
                            ${icons ? `<div class="player-icons">${icons}</div>` : ''}
                        </div>
                        <div class="player-pts ${ptsClass}">${p.points}</div>
                    </div>
                `;
            };

            // Render away player row: Score on left, icons+name right aligned
            const renderAwayPlayerRow = (p) => {
                if (!p) return '<div class="player-row-sbs" style="visibility: hidden;"></div>';
                const ptsClass = p.points > 0 ? 'positive' : (p.points < 0 ? 'negative' : 'zero');
                const icons = renderIcons(p);
                return `
                    <div class="player-row-sbs clickable" onclick="showMatchPlayerSheet(${p.id})">
                        <div class="player-pts ${ptsClass}">${p.points}</div>
                        <div class="player-name-group">
                            ${icons ? `<div class="player-icons">${icons}</div>` : ''}
                            <span class="player-name">${p.name}</span>
                        </div>
                    </div>
                `;
            };

            // Build side-by-side team columns with starters/subs separation
            let homeRows = '';
            let awayRows = '';

            // Render starters
            const maxStarters = Math.max(homeStarters.length, awayStarters.length);
            for (let i = 0; i < maxStarters; i++) {
                homeRows += renderHomePlayerRow(homeStarters[i]);
                awayRows += renderAwayPlayerRow(awayStarters[i]);
            }

            // Add divider if there are subs
            if (homeSubs.length > 0 || awaySubs.length > 0) {
                homeRows += '<div class="team-divider">Substitutes</div>';
                awayRows += '<div class="team-divider">Substitutes</div>';
            }

            // Render subs
            const maxSubs = Math.max(homeSubs.length, awaySubs.length);
            for (let i = 0; i < maxSubs; i++) {
                homeRows += renderHomePlayerRow(homeSubs[i]);
                awayRows += renderAwayPlayerRow(awaySubs[i]);
            }

            // Build Defensive Contribution table
            // Defcon threshold: 10 for DEF, 12 for MID/FWD (no defcons for GKP)
            const getDefconThreshold = (position) => position === 'DEF' ? 10 : 12;
            const hasReachedDefconThreshold = (p) => {
                if (p.position === 'GKP') return false;
                return p.defcon >= getDefconThreshold(p.position);
            };

            const homeDefcons = homePlayers.filter(p => p.defcon > 0)
                .sort((a, b) => (b.defcon || 0) - (a.defcon || 0));
            const awayDefcons = awayPlayers.filter(p => p.defcon > 0)
                .sort((a, b) => (b.defcon || 0) - (a.defcon || 0));

            let dcHtml = '';
            if (homeDefcons.length > 0 || awayDefcons.length > 0) {
                const maxDcRows = Math.max(homeDefcons.length, awayDefcons.length);
                let dcRows = '';

                for (let i = 0; i < Math.min(maxDcRows, 12); i++) {
                    const homeP = homeDefcons[i];
                    const awayP = awayDefcons[i];

                    const homeAchieved = homeP && hasReachedDefconThreshold(homeP);
                    const awayAchieved = awayP && hasReachedDefconThreshold(awayP);

                    const homeCell = homeP ? `
                        <div class="stats-table-col home">
                            <span class="stats-player-name">${homeP.name}${homeAchieved ? ' ðŸ”’' : ''}</span>
                            <span class="dc-value${homeAchieved ? ' achieved' : ''}">${homeP.defcon}</span>
                        </div>
                    ` : '<div class="stats-table-col home"></div>';

                    const awayCell = awayP ? `
                        <div class="stats-table-col away">
                            <span class="dc-value${awayAchieved ? ' achieved' : ''}">${awayP.defcon}</span>
                            <span class="stats-player-name">${awayAchieved ? 'ðŸ”’ ' : ''}${awayP.name}</span>
                        </div>
                    ` : '<div class="stats-table-col away"></div>';

                    dcRows += `<div class="stats-table-row">${homeCell}${awayCell}</div>`;
                }

                dcHtml = `
                    <div class="stats-table-section">
                        <div class="stats-table-header">
                            <span>ðŸ›¡ï¸</span> Defensive Contribution
                        </div>
                        <div class="stats-table">${dcRows}</div>
                    </div>
                `;
            }

            // Build Keeper Saves section - only show icon if 3+ saves (points milestone)
            const homeGK = homePlayers.find(p => p.position === 'GKP' && p.saves > 0);
            const awayGK = awayPlayers.find(p => p.position === 'GKP' && p.saves > 0);

            let savesHtml = '';
            if (homeGK || awayGK) {
                // Calculate save points milestones (3 saves = 1 pt, 6 saves = 2 pts, etc.)
                const getSavesMilestones = (saves) => Math.floor(saves / 3);

                const homeCell = homeGK ? `
                    <div class="stats-table-col home">
                        <span class="stats-player-name">${homeGK.name}${getSavesMilestones(homeGK.saves) > 0 ? ' ðŸ§¤' : ''}${getSavesMilestones(homeGK.saves) > 1 ? `<span class="icon-count">${getSavesMilestones(homeGK.saves)}</span>` : ''}</span>
                        <span class="saves-value${getSavesMilestones(homeGK.saves) > 0 ? ' achieved' : ''}">${homeGK.saves}</span>
                    </div>
                ` : '<div class="stats-table-col home"></div>';

                const awayCell = awayGK ? `
                    <div class="stats-table-col away">
                        <span class="saves-value${getSavesMilestones(awayGK.saves) > 0 ? ' achieved' : ''}">${awayGK.saves}</span>
                        <span class="stats-player-name">${getSavesMilestones(awayGK.saves) > 0 ? 'ðŸ§¤' : ''}${getSavesMilestones(awayGK.saves) > 1 ? `<span class="icon-count">${getSavesMilestones(awayGK.saves)}</span>` : ''} ${awayGK.name}</span>
                    </div>
                ` : '<div class="stats-table-col away"></div>';

                savesHtml = `
                    <div class="stats-table-section">
                        <div class="stats-table-header">
                            <span>ðŸ§¤</span> Keeper Saves
                        </div>
                        <div class="stats-table">
                            <div class="stats-table-row">${homeCell}${awayCell}</div>
                        </div>
                    </div>
                `;
            }

            // Build Bonus Points table - show BPS and earned bonus
            const playersWithBps = allPlayers.filter(p => p.bps > 0).sort((a, b) => b.bps - a.bps);

            let bpHtml = '';
            if (playersWithBps.length > 0) {
                // Calculate projected bonus
                const bpsValues = [...new Set(playersWithBps.map(p => p.bps))].sort((a, b) => b - a);
                const bonusMap = {};
                let currentRank = 1;

                for (const bpsVal of bpsValues) {
                    if (currentRank > 3) break;
                    const bonusForRank = currentRank === 1 ? 3 : currentRank === 2 ? 2 : currentRank === 3 ? 1 : 0;
                    if (bonusForRank === 0) break;
                    const playersAtThisBps = playersWithBps.filter(p => p.bps === bpsVal).length;
                    bonusMap[bpsVal] = bonusForRank;
                    currentRank += playersAtThisBps;
                }

                // Split into home and away for side-by-side, sorted by BPS within each team
                const homeBps = playersWithBps.filter(p => homePlayers.some(hp => hp.id === p.id)).slice(0, 12);
                const awayBps = playersWithBps.filter(p => awayPlayers.some(ap => ap.id === p.id)).slice(0, 12);
                const maxBpRows = Math.max(homeBps.length, awayBps.length);

                let bpRows = '';
                for (let i = 0; i < Math.min(maxBpRows, 12); i++) {
                    const homeP = homeBps[i];
                    const awayP = awayBps[i];

                    const homeBonus = homeP ? (bonusMap[homeP.bps] || 0) : 0;
                    const awayBonus = awayP ? (bonusMap[awayP.bps] || 0) : 0;

                    const homeCell = homeP ? `
                        <div class="stats-table-col home">
                            <span class="stats-player-name">${homeP.name}</span>
                            <span class="bp-value">${homeBonus > 0 ? `<span class="bp-earned">+${homeBonus}</span> ` : ''}[${homeP.bps}]</span>
                        </div>
                    ` : '<div class="stats-table-col home"></div>';

                    const awayCell = awayP ? `
                        <div class="stats-table-col away">
                            <span class="bp-value">[${awayP.bps}]${awayBonus > 0 ? ` <span class="bp-earned">+${awayBonus}</span>` : ''}</span>
                            <span class="stats-player-name">${awayP.name}</span>
                        </div>
                    ` : '<div class="stats-table-col away"></div>';

                    bpRows += `<div class="stats-table-row">${homeCell}${awayCell}</div>`;
                }

                bpHtml = `
                    <div class="stats-table-section">
                        <div class="stats-table-header">
                            <span>â­</span> Bonus Points
                        </div>
                        <div class="stats-table">${bpRows}</div>
                    </div>
                `;
            }

            const html = `
                <div class="teams-side-by-side">
                    <div class="team-column home">
                        <div class="team-column-header">${fixture.home}</div>
                        ${homeRows}
                    </div>
                    <div class="team-column away">
                        <div class="team-column-header">${fixture.away}</div>
                        ${awayRows}
                    </div>
                </div>
                <div class="stats-tables-container">
                    ${dcHtml}
                    ${savesHtml}
                    ${bpHtml}
                </div>
            `;

            document.getElementById('match-modal-body').innerHTML = html;
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-overlay').classList.remove('active');
            document.body.style.overflow = '';
            currentPicksData = null;
            currentTinkeringData = null;
            currentModalGW = null;
            currentModalEntryId = null;
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closePlayerSheet();
            }
        });

        window.addEventListener('resize', () => {
            isMobile = window.innerWidth < 768;
        });

        // Swipe gesture support for GW navigation
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        const SWIPE_THRESHOLD = 50;

        function handleSwipe() {
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            // Only trigger if primarily horizontal (X movement > Y movement)
            // This prevents vertical scrolling from triggering GW navigation
            if (Math.abs(diffX) < SWIPE_THRESHOLD) return;
            if (Math.abs(diffY) > Math.abs(diffX)) return;

            if (diffX > 0) {
                // Swipe left - go to next GW
                navigateGW(1);
            } else {
                // Swipe right - go to previous GW
                navigateGW(-1);
            }
        }

        document.getElementById('modal-overlay').addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        document.getElementById('modal-overlay').addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }, { passive: true });

        // Handle URL parameters for deep linking (e.g., from losers page)
        let urlParamsProcessed = false;
        async function handleUrlParams() {
            // Only process once (not on refresh intervals)
            if (urlParamsProcessed) return;

            const params = new URLSearchParams(window.location.search);
            const entryId = params.get('entry');
            const targetGW = params.get('gw');

            if (entryId && weekData?.managers) {
                urlParamsProcessed = true;
                const manager = weekData.managers.find(m => m.entryId === parseInt(entryId));
                if (manager) {
                    // Open the modal
                    currentModalEntryId = parseInt(entryId);
                    currentModalGW = targetGW ? parseInt(targetGW) : weekData.currentGW;

                    document.getElementById('modal-manager-name').textContent = manager.name;
                    document.getElementById('modal-team-name').textContent = manager.team;
                    document.getElementById('gw-label').textContent = `GW ${currentModalGW}`;
                    document.getElementById('modal-body').innerHTML = '<div class="loading" style="padding: 2rem; color: #666;">Loading team...</div>';
                    document.getElementById('modal-overlay').classList.add('active');
                    document.body.style.overflow = 'hidden';

                    await loadModalData(parseInt(entryId), currentModalGW);

                    // Clear URL params after opening modal (cleaner browser history)
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }
        }

        loadWeekData();
    </script>
</body>
</html>
