<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Current Week - FPL League</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/season-selector.js" defer></script>
    <style>
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background: rgba(255,255,255,0.1); }
        th.sortable.asc::after { content: ' \2191'; opacity: 0.7; }
        th.sortable.desc::after { content: ' \2193'; opacity: 0.7; }

        .live-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--danger);
            color: var(--white);
            padding: 0.4rem 0.85rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .live-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--white);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .last-updated {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .chip-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .chip-badge.wildcard { background: #9b59b6; color: white; }
        .chip-badge.freehit { background: #3498db; color: white; }
        .chip-badge.bboost { background: #e67e22; color: white; }
        .chip-badge.3xc { background: #27ae60; color: white; }

        /* Manager info pills under team name */
        .manager-pills {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.35rem;
            flex-wrap: wrap;
        }
        .info-pill {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            line-height: 1.2;
        }
        .chip-pill.wildcard { background: #9b59b6; color: white; }
        .chip-pill.freehit { background: #3498db; color: white; }
        .chip-pill.bboost { background: #e67e22; color: white; }
        .chip-pill.3xc { background: #27ae60; color: white; }
        .left-pill { background: rgba(0,0,0,0.08); color: #666; }

        /* Modal - Clean FPL App Style */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 0;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            overflow-y: auto;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #f5f5f5;
            border-radius: 0;
            width: 100%;
            min-height: 100%;
            overflow: visible;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        @media (min-width: 500px) {
            .modal-overlay {
                padding: 1rem;
                align-items: center;
            }
            .modal {
                max-width: 480px;
                border-radius: 20px;
                min-height: auto;
                max-height: 90vh;
                overflow: hidden;
            }
            .modal .modal-body {
                overflow-y: auto;
            }
        }

        @media (min-width: 768px) {
            .modal {
                max-width: 520px;
            }
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            background: #fff;
            padding: 1rem 1.5rem;
            padding-top: 2.5rem;
            position: relative;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header-info {
            flex: 1;
            min-width: 0;
        }

        .modal-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal-header .team-name {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal-points {
            font-size: 2.8rem;
            font-weight: 800;
            color: #333;
            line-height: 1;
            margin-right: 2.5rem;
            flex-shrink: 0;
        }

        .modal-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.75rem;
            color: #999;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            flex: 1;
            overflow-y: visible;
            padding: 0;
        }

        @media (min-width: 500px) {
            .modal-body {
                overflow-y: auto;
            }
        }

        /* Pitch - Full Width Green with stripes */
        .pitch-container {
            background: linear-gradient(180deg,
                #3d9140 0%, #348f37 10%,
                #3d9140 10%, #348f37 20%,
                #3d9140 20%, #348f37 30%,
                #3d9140 30%, #348f37 40%,
                #3d9140 40%, #348f37 50%,
                #3d9140 50%, #348f37 60%,
                #3d9140 60%, #348f37 70%,
                #3d9140 70%, #348f37 80%,
                #3d9140 80%, #348f37 90%,
                #3d9140 90%, #348f37 100%
            );
            padding: 0.75rem 0;
            position: relative;
            border-radius: 0;
            margin: 0;
            width: 100%;
        }

        .pitch-markings {
            position: absolute;
            inset: 0.5rem 1rem;
            border: 2px solid rgba(255,255,255,0.35);
            pointer-events: none;
        }

        .pitch-center {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 50px;
            height: 50px;
            border: 2px solid rgba(255,255,255,0.35);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .pitch-halfway {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background: rgba(255,255,255,0.35);
        }

        .pitch-box-top {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 35px;
            border: 2px solid rgba(255,255,255,0.35);
            border-top: none;
        }

        .pitch-box-bottom {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 35px;
            border: 2px solid rgba(255,255,255,0.35);
            border-bottom: none;
        }

        .formation-row {
            display: flex;
            justify-content: center;
            gap: 2px;
            padding: 0.5rem 0;
            position: relative;
            z-index: 1;
        }

        .formation-row.gk { padding-top: 0.5rem; }
        .formation-row.fwd { padding-bottom: 0.5rem; }

        /* Player Card - Transparent, sized for 5 across with bigger shirts */
        .player-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: calc((100vw - 10px) / 5);
            max-width: 100px;
            min-width: 68px;
            cursor: pointer;
            position: relative;
            background: transparent;
            padding: 2px 0;
        }

        @media (min-width: 500px) {
            .player-card {
                width: calc((500px - 20px) / 5);
                max-width: 96px;
            }
        }

        .player-card.subbed-out {
            opacity: 0.35;
        }

        .player-card.subbed-in::before {
            content: 'â†‘';
            position: absolute;
            top: 0;
            left: 0;
            background: #27ae60;
            color: white;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            font-size: 0.55rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Shirt image - inflated for better visibility */
        .player-shirt {
            width: 52px;
            height: 52px;
            position: relative;
            margin-bottom: 2px;
        }

        .player-shirt img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
        }

        .captain-badge {
            position: absolute;
            bottom: 0;
            right: -4px;
            width: 15px;
            height: 15px;
            background: #000;
            color: white;
            border-radius: 50%;
            font-size: 0.55rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid white;
            z-index: 5;
        }

        .vice-badge {
            position: absolute;
            bottom: 0;
            right: -4px;
            width: 15px;
            height: 15px;
            background: #666;
            color: white;
            border-radius: 50%;
            font-size: 0.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid white;
            z-index: 5;
        }

        /* Player name - no background, clean text */
        .player-name-box {
            padding: 1px 3px;
            margin-bottom: 1px;
            max-width: 100%;
        }

        .player-name {
            font-family: 'Inter', sans-serif;
            font-size: 0.6rem;
            font-weight: 700;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc((100vw - 10px) / 5 - 8px);
            display: block;
            letter-spacing: -0.3px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8), 0 0 8px rgba(0,0,0,0.5);
        }

        @media (min-width: 500px) {
            .player-name {
                max-width: 80px;
            }
        }

        .player-points-pill {
            background: #37003c;
            color: #fff;
            padding: 1px 5px;
            border-radius: 2px;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 22px;
            text-align: center;
        }

        .player-points-pill.not-played {
            background: rgba(55, 0, 60, 0.75);
            color: rgba(255,255,255,0.85);
            font-size: 0.55rem;
        }

        .player-points-pill.playing {
            animation: pointsPulse 1.5s infinite;
        }

        @keyframes pointsPulse {
            0%, 100% { background: #37003c; }
            50% { background: #00ff85; color: #000; }
        }

        .player-events {
            display: flex;
            gap: 1px;
            margin-top: 1px;
            font-size: 0.5rem;
        }

        /* Bench Area */
        .bench-container {
            background: #ddd;
            padding: 0.5rem 0.75rem;
        }

        .bench-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .bench-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bench-points {
            font-size: 0.75rem;
            font-weight: 700;
            color: #777;
        }

        .bench-row {
            display: flex;
            justify-content: space-around;
        }

        .bench-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bench-slot .player-card {
            width: 56px;
            min-width: 56px;
        }

        .bench-slot .player-shirt {
            width: 34px;
            height: 34px;
        }

        .bench-slot .player-name {
            max-width: 52px;
            font-size: 0.52rem;
        }

        .bench-slot .player-points-pill {
            font-size: 0.6rem;
            padding: 1px 4px;
        }

        .bench-position {
            font-size: 0.5rem;
            color: #888;
            margin-bottom: 0.2rem;
        }

        /* Formation Label */
        .formation-bar {
            background: #ddd;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            color: #666;
        }

        .formation-bar strong {
            color: #e91e63;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: #333;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-header {
            font-weight: 700;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #555;
            padding-bottom: 0.35rem;
        }

        .tooltip-row {
            display: flex;
            gap: 1.5rem;
            padding: 0.3rem 0;
            align-items: center;
        }

        .tooltip-row .stat {
            color: #ccc;
        }

        .tooltip-row .value {
            margin-left: auto;
            color: #aaa;
        }

        .tooltip-row .pts {
            min-width: 45px;
            text-align: right;
            font-weight: 600;
        }

        .tooltip-row.total {
            margin-top: 0.5rem;
            border-top: 1px solid #555;
            padding-top: 0.5rem;
            font-weight: 700;
        }

        .tooltip-row.total .stat {
            color: white;
        }

        /* Mobile bottom sheet for player details */
        .player-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            max-height: 50vh;
            overflow-y: auto;
        }

        .player-sheet.visible {
            transform: translateY(0);
        }

        .player-sheet-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .player-sheet-badge {
            width: 50px;
            height: 50px;
            position: relative;
        }

        .player-sheet-badge img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .player-sheet-info h3 {
            font-size: 1.1rem;
            color: #333;
            margin: 0;
        }

        .player-sheet-info p {
            font-size: 0.85rem;
            color: #666;
            margin: 0;
        }

        .player-sheet-points {
            font-size: 2rem;
            font-weight: 800;
            color: #333;
            margin-left: auto;
        }

        .points-breakdown {
            background: #f5f5f5;
            border-radius: 12px;
            overflow: hidden;
        }

        .breakdown-header {
            display: grid;
            grid-template-columns: 1fr 60px 70px;
            padding: 0.75rem 1rem;
            background: #e0e0e0;
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        .breakdown-row {
            display: grid;
            grid-template-columns: 1fr 60px 70px;
            padding: 0.6rem 1rem;
            border-bottom: 1px solid #e8e8e8;
            font-size: 0.9rem;
        }

        .breakdown-row:last-child {
            border-bottom: none;
        }

        .breakdown-stat {
            color: #333;
        }

        .breakdown-value {
            text-align: center;
            color: #666;
        }

        .breakdown-pts {
            text-align: right;
            font-weight: 600;
            color: #27ae60;
        }

        .breakdown-pts.negative {
            color: #e74c3c;
        }

        .breakdown-total {
            display: grid;
            grid-template-columns: 1fr 60px 70px;
            padding: 0.75rem 1rem;
            background: #333;
            color: white;
            font-weight: 700;
        }

        .breakdown-total span:last-child {
            text-align: right;
        }

        .sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sheet-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Auto-subs indicator */
        .auto-subs-bar {
            background: #fff3cd;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auto-subs-bar svg {
            width: 16px;
            height: 16px;
        }

        /* GW Navigation - positioned at top of header */
        .gw-nav {
            position: absolute;
            top: 0.5rem;
            left: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .gw-nav-btn {
            background: #f0f0f0;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #333;
            font-size: 1.1rem;
            transition: background 0.2s, opacity 0.2s;
        }

        .gw-nav-btn:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .gw-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .gw-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
            min-width: 50px;
            text-align: center;
        }

        /* Tinkering Bar */
        .tinkering-bar {
            background: #f8f9fa;
            border-top: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tinkering-bar:hover {
            background: #f0f1f2;
        }

        .tinkering-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
        }

        .tinkering-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
        }

        .tinkering-title svg {
            width: 16px;
            height: 16px;
            color: #888;
        }

        .tinkering-impact {
            font-size: 1rem;
            font-weight: 700;
        }

        .tinkering-impact.positive {
            color: #27ae60;
        }

        .tinkering-impact.negative {
            color: #e74c3c;
        }

        .tinkering-impact.neutral {
            color: #666;
        }

        .tinkering-toggle {
            font-size: 0.75rem;
            color: #999;
            transition: transform 0.2s;
        }

        .tinkering-bar.expanded .tinkering-toggle {
            transform: rotate(180deg);
        }

        .tinkering-details {
            display: none;
            padding: 0 1rem 1rem;
            font-size: 0.85rem;
        }

        .tinkering-bar.expanded .tinkering-details {
            display: block;
        }

        .tinkering-summary {
            background: #fff;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .tinkering-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            color: #666;
        }

        .tinkering-row.total {
            border-top: 1px solid #eee;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            font-weight: 700;
            color: #333;
        }

        .tinkering-row.total .tinkering-impact {
            font-size: 0.95rem;
        }

        .tinkering-section {
            margin-top: 0.75rem;
        }

        .tinkering-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .tinkering-section-title.positive {
            color: #27ae60;
        }

        .tinkering-section-title.negative {
            color: #e74c3c;
        }

        .tinkering-item {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
            color: #555;
        }

        .tinkering-item .points {
            font-weight: 600;
        }

        .tinkering-item .points.positive {
            color: #27ae60;
        }

        .tinkering-item .points.negative {
            color: #e74c3c;
        }

        .tinkering-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        .tinkering-badge.freehit {
            background: #3498db;
            color: white;
        }

        .tinkering-badge.wildcard {
            background: #9b59b6;
            color: white;
        }

        .tinkering-unavailable {
            padding: 0.75rem 1rem;
            color: #888;
            font-size: 0.85rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-inner">
            <a href="/" class="navbar-brand">Barry's FPL Mini League</a>
            <button class="nav-toggle" onclick="this.classList.toggle('active');document.querySelector('.navbar-links').classList.toggle('active')">
                <span></span><span></span><span></span>
            </button>
            <div class="navbar-links">
                <a href="/">Home</a>
                <a href="/week" class="active">This Week</a>
                <a href="/standings">Standings</a>
                <a href="/losers">Weekly Losers</a>
                <a href="/motm">MotM</a>
                <a href="/chips">Chips</a>
                <a href="/earnings">Earnings</a>
                <a href="/hall-of-fame">Hall of Fame</a>
                <a href="/rules">Rules</a>
            </div>
        </div>
    </nav>

    <div class="page-header">
        <h1 id="league-name">Loading...</h1>
        <p class="subtitle" id="gw-subtitle">Current Week</p>
    </div>

    <main>
        <div id="content">
            <div class="loading">Loading week data...</div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="gw-nav">
                    <button class="gw-nav-btn" id="gw-prev" onclick="navigateGW(-1)" disabled>&lt;</button>
                    <span class="gw-label" id="gw-label">GW 1</span>
                    <button class="gw-nav-btn" id="gw-next" onclick="navigateGW(1)" disabled>&gt;</button>
                </div>
                <div class="modal-header-info">
                    <h2 id="modal-manager-name">Manager</h2>
                    <div class="team-name" id="modal-team-name"></div>
                </div>
                <div class="modal-points" id="modal-points">0</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
        </div>
    </div>

    <!-- Tooltip for desktop -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Mobile player sheet -->
    <div class="sheet-overlay" id="sheet-overlay" onclick="closePlayerSheet()"></div>
    <div class="player-sheet" id="player-sheet"></div>

    <script>
        let weekData = null;
        let currentPicksData = null;
        let currentTinkeringData = null;
        let currentModalGW = null;
        let currentModalEntryId = null;
        let currentSort = { col: 'gwScore', asc: false };
        let refreshInterval = null;
        let isMobile = window.innerWidth < 768;

        const CHIP_NAMES = {
            'wildcard': 'WC',
            'freehit': 'FH',
            'bboost': 'BB',
            '3xc': 'TC'
        };

        const POSITION_LABELS = ['GKP', '1st Sub', '2nd Sub', '3rd Sub'];

        function sortTable(col) {
            if (currentSort.col === col) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.col = col;
                currentSort.asc = col === 'manager';
            }

            const sortKey = {
                'gwRank': m => m.gwRank,
                'manager': m => m.name.toLowerCase(),
                'gwScore': m => m.gwScore,
                'playersLeft': m => m.playersLeft,
                'teamValue': m => parseFloat(m.teamValue),
                'benchPoints': m => m.benchPoints
            }[col];

            weekData.managers.sort((a, b) => {
                const aVal = sortKey(a), bVal = sortKey(b);
                if (typeof aVal === 'string') return currentSort.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                return currentSort.asc ? aVal - bVal : bVal - aVal;
            });

            renderTable();
        }

        function sortClass(col) {
            if (currentSort.col !== col) return '';
            return currentSort.asc ? 'asc' : 'desc';
        }

        function renderTable() {
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable ${sortClass('gwRank')}" onclick="sortTable('gwRank')">#</th>
                            <th class="col-manager sortable ${sortClass('manager')}" onclick="sortTable('manager')">Manager</th>
                            <th class="num sortable ${sortClass('gwScore')}" onclick="sortTable('gwScore')">Pts</th>
                            <th class="num sortable ${sortClass('teamValue')}" onclick="sortTable('teamValue')">Value</th>
                            <th class="num sortable ${sortClass('benchPoints')}" onclick="sortTable('benchPoints')">Bench</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            weekData.managers.forEach(m => {
                const rankClass = m.gwRank <= 3 ? `rank-${m.gwRank}` : '';

                // Build info pills for under team name
                let pills = [];
                if (m.activeChip) {
                    pills.push(`<span class="info-pill chip-pill ${m.activeChip}">${CHIP_NAMES[m.activeChip]}</span>`);
                }
                if (m.playersLeft > 0) {
                    pills.push(`<span class="info-pill left-pill">${m.playersLeft} left</span>`);
                }
                const pillsHtml = pills.length > 0 ? `<div class="manager-pills">${pills.join('')}</div>` : '';

                html += `
                    <tr class="clickable" onclick="openManagerModal(${m.entryId})">
                        <td class="rank-cell ${rankClass}">${m.gwRank}</td>
                        <td class="col-manager">
                            <strong>${m.name}</strong>
                            <div class="team-name">${m.team}</div>
                            ${pillsHtml}
                        </td>
                        <td class="num"><span class="badge badge-success">${m.gwScore}</span></td>
                        <td class="num">Â£${m.teamValue}m</td>
                        <td class="num">${m.benchPoints}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.querySelector('.table-container').innerHTML = html;
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        }

        async function loadWeekData() {
            try {
                const res = await fetch('/api/week' + (window.getSeasonParam ? window.getSeasonParam() : ''));
                weekData = await res.json();

                document.getElementById('league-name').textContent = weekData.leagueName;
                document.getElementById('gw-subtitle').textContent = `Gameweek ${weekData.currentGW}`;

                const liveIndicator = weekData.isLive
                    ? '<span class="live-indicator">LIVE</span>'
                    : '';
                const lastUpdated = `<span class="last-updated">Updated ${formatTime(weekData.lastUpdated)}</span>`;

                let html = `
                    <div class="live-header">
                        <div>${liveIndicator}</div>
                        <div>${lastUpdated}</div>
                    </div>
                    <div class="table-container"></div>
                `;

                document.getElementById('content').innerHTML = html;
                renderTable();

                if (weekData.isLive) {
                    if (!refreshInterval) {
                        refreshInterval = setInterval(loadWeekData, 60000);
                    }
                } else if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="loading">Error: ${error.message}</div>`;
            }
        }

        async function openManagerModal(entryId) {
            const manager = weekData.managers.find(m => m.entryId === entryId);
            if (!manager) return;

            // Initialize modal state
            currentModalEntryId = entryId;
            currentModalGW = weekData.currentGW;

            document.getElementById('modal-manager-name').textContent = manager.name;
            document.getElementById('modal-team-name').textContent = manager.team;
            document.getElementById('modal-points').textContent = manager.gwScore;
            document.getElementById('gw-label').textContent = `GW ${currentModalGW}`;
            document.getElementById('modal-body').innerHTML = '<div class="loading" style="padding: 2rem; color: #666;">Loading team...</div>';
            document.getElementById('modal-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';

            await loadModalData(entryId, currentModalGW);
        }

        async function navigateGW(direction) {
            if (!currentModalEntryId) return;

            const newGW = currentModalGW + direction;
            if (newGW < 1 || (currentTinkeringData?.navigation && newGW > currentTinkeringData.navigation.maxGW)) {
                return;
            }

            currentModalGW = newGW;
            document.getElementById('gw-label').textContent = `GW ${currentModalGW}`;
            document.getElementById('modal-body').innerHTML = '<div class="loading" style="padding: 2rem; color: #666;">Loading team...</div>';

            await loadModalData(currentModalEntryId, currentModalGW);
        }

        async function loadModalData(entryId, gw) {
            try {
                // Fetch picks and tinkering data in parallel
                const [picksRes, tinkeringRes] = await Promise.all([
                    fetch(`/api/manager/${entryId}/picks?gw=${gw}`),
                    fetch(`/api/manager/${entryId}/tinkering?gw=${gw}`)
                ]);

                currentPicksData = await picksRes.json();
                currentTinkeringData = await tinkeringRes.json();

                // Update points display
                document.getElementById('modal-points').textContent = currentPicksData.calculatedPoints || currentPicksData.points;

                // Render pitch and tinkering bar
                renderPitchView(currentPicksData);

                // Update navigation buttons
                updateNavButtons();
            } catch (error) {
                document.getElementById('modal-body').innerHTML = `<div class="loading" style="padding: 2rem; color: var(--danger);">Error: ${error.message}</div>`;
            }
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('gw-prev');
            const nextBtn = document.getElementById('gw-next');

            if (currentTinkeringData?.navigation) {
                const nav = currentTinkeringData.navigation;
                prevBtn.disabled = currentModalGW <= 1;
                nextBtn.disabled = currentModalGW >= nav.maxGW;
            } else {
                prevBtn.disabled = currentModalGW <= 1;
                nextBtn.disabled = currentModalGW >= weekData.currentGW;
            }
        }

        function renderPlayerShirt(player) {
            const teamCode = player.teamCode || 1;
            // Use GK shirt for goalkeepers (positionId === 1)
            const shirtSuffix = player.positionId === 1 ? '_1' : '';
            const shirtUrl = `https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${teamCode}${shirtSuffix}-110.webp`;

            return `
                <div class="player-shirt">
                    <img src="${shirtUrl}" alt="${player.teamName}" onerror="this.src='https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_0-110.webp'">
                    ${player.isCaptain ? '<div class="captain-badge">C</div>' : ''}
                    ${player.isViceCaptain ? '<div class="vice-badge">V</div>' : ''}
                </div>
            `;
        }

        function getPointsDisplay(player, isBench = false) {
            const basePoints = player.totalPoints || player.points || 0;

            // Bench players (not subbed in) always show their actual points
            if (isBench) {
                return `<div class="player-points-pill">${basePoints}</div>`;
            }

            // If hasn't played yet, show opponent
            if (player.playStatus === 'not_started') {
                return `<div class="player-points-pill not-played">${player.opponent || '-'}</div>`;
            }
            if (player.playStatus === 'not_played_yet') {
                return `<div class="player-points-pill not-played">-</div>`;
            }

            // Calculate effective points
            // Subbed-in players get x1 (no captain bonus), original starters use their multiplier
            let effectiveMultiplier = player.subIn ? 1 : (player.isCaptain ? 2 : player.multiplier);
            const pts = basePoints * effectiveMultiplier;
            const playingClass = player.playStatus === 'playing' ? 'playing' : '';
            return `<div class="player-points-pill ${playingClass}">${pts}</div>`;
        }

        // Icon configuration for player events
        const EVENT_ICONS = {
            'goals_scored': { icon: 'âš½', showCount: true },
            'own_goals': { icon: 'âš½', showCount: true, style: 'filter: hue-rotate(320deg) saturate(1.5);' },
            'assists': { icon: 'ðŸ‘Ÿ', showCount: true },
            'clean_sheets': { icon: 'ðŸ›¡ï¸', showCount: false },
            'defensive_contribution': { icon: 'ðŸ”’', showCount: false },
            'yellow_cards': { icon: 'ðŸŸ¨', showCount: false },
            'red_cards': { icon: 'ðŸŸ¥', showCount: false },
            'penalties_saved': { icon: 'ðŸ§¤', showCount: false },
            'penalties_missed': { icon: 'âŒ', showCount: false },
            'saves': { icon: 'ðŸ§¤', showCount: false }
        };

        function buildEventIcons(pointsBreakdown) {
            if (!pointsBreakdown) return '';

            // Check if player has red card (replaces yellow)
            const hasRed = pointsBreakdown.some(p => p.identifier === 'red_cards');

            const icons = [];
            const priorityOrder = ['goals_scored', 'own_goals', 'assists', 'clean_sheets', 'defensive_contribution', 'red_cards', 'yellow_cards', 'penalties_saved', 'penalties_missed', 'saves'];

            priorityOrder.forEach(type => {
                if (type === 'yellow_cards' && hasRed) return;

                const breakdown = pointsBreakdown.find(p => p.identifier === type);
                if (!breakdown) return;

                const config = EVENT_ICONS[type];
                if (!config) return;

                const count = typeof breakdown.value === 'number' ? breakdown.value : 1;
                const showNum = config.showCount && count > 1;
                const style = config.style || '';

                icons.push(`<span title="${breakdown.stat}" style="${style}">${config.icon}${showNum ? count : ''}</span>`);
            });

            return icons.join('');
        }

        function renderPlayer(player, isBench = false) {
            const subClass = player.subOut ? 'subbed-out' : (player.subIn ? 'subbed-in' : '');
            const eventsHtml = buildEventIcons(player.pointsBreakdown);

            return `
                <div class="player-card ${subClass}"
                     data-player-id="${player.id}"
                     onmouseenter="showTooltip(event, ${player.id})"
                     onmouseleave="hideTooltip()"
                     onclick="handlePlayerClick(${player.id})">
                    ${renderPlayerShirt(player)}
                    <div class="player-name-box">
                        <span class="player-name">${player.name}</span>
                    </div>
                    ${getPointsDisplay(player, isBench)}
                    ${!isBench && eventsHtml ? `<div class="player-events">${eventsHtml}</div>` : ''}
                </div>
            `;
        }

        function renderPitchView(data) {
            // Separate starters and bench, account for auto-subs
            const effectiveStarters = data.players.filter(p => (!p.isBench && !p.subOut) || p.subIn);
            const effectiveBench = data.players.filter(p => (p.isBench && !p.subIn) || p.subOut);

            // Sort bench by original bench order
            effectiveBench.sort((a, b) => {
                const aOrder = a.isBench ? a.benchOrder : 99;
                const bOrder = b.isBench ? b.benchOrder : 99;
                return aOrder - bOrder;
            });

            // Group by position
            const gk = effectiveStarters.filter(p => p.positionId === 1);
            const def = effectiveStarters.filter(p => p.positionId === 2);
            const mid = effectiveStarters.filter(p => p.positionId === 3);
            const fwd = effectiveStarters.filter(p => p.positionId === 4);

            const chipText = data.activeChip ? ` - ${CHIP_NAMES[data.activeChip] || data.activeChip} Active` : '';

            // Auto-subs notification
            let autoSubsHtml = '';
            if (data.autoSubs && data.autoSubs.length > 0) {
                const subText = data.autoSubs.map(s => `${s.in.name} for ${s.out.name}`).join(', ');
                autoSubsHtml = `
                    <div class="auto-subs-bar">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                        Auto-sub: ${subText}
                    </div>
                `;
            }

            let html = `
                <div class="formation-bar">Formation: <strong>${data.formation}</strong>${chipText}</div>
                ${autoSubsHtml}
                <div class="pitch-container">
                    <div class="pitch-markings">
                        <div class="pitch-halfway"></div>
                        <div class="pitch-center"></div>
                        <div class="pitch-box-top"></div>
                        <div class="pitch-box-bottom"></div>
                    </div>
                    <div class="formation-row gk">${gk.map(p => renderPlayer(p)).join('')}</div>
                    <div class="formation-row">${def.map(p => renderPlayer(p)).join('')}</div>
                    <div class="formation-row">${mid.map(p => renderPlayer(p)).join('')}</div>
                    <div class="formation-row fwd">${fwd.map(p => renderPlayer(p)).join('')}</div>
                </div>
                <div class="bench-container">
                    <div class="bench-header">
                        <span class="bench-label">Substitutes</span>
                        <span class="bench-points">${data.pointsOnBench} pts</span>
                    </div>
                    <div class="bench-row">
                        ${effectiveBench.map((p, i) => `
                            <div class="bench-slot">
                                <div class="bench-position">${POSITION_LABELS[i] || ''}</div>
                                ${renderPlayer(p, true)}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${renderTinkeringBar()}
            `;

            document.getElementById('modal-body').innerHTML = html;
        }

        function renderTinkeringBar() {
            if (!currentTinkeringData) return '';

            // If tinkering not available (GW1 or error)
            if (!currentTinkeringData.available) {
                if (currentTinkeringData.reason === 'gw1') {
                    return `<div class="tinkering-unavailable">No tinkering data for GW1 (no previous team to compare)</div>`;
                }
                return '';
            }

            const { actualScore, hypotheticalScore, transferCost, netImpact, reason,
                    transfersIn, transfersOut, captainChange, lineupChanges } = currentTinkeringData;

            // Determine impact class
            let impactClass = 'neutral';
            if (netImpact > 0) impactClass = 'positive';
            else if (netImpact < 0) impactClass = 'negative';

            // Format impact display
            const impactDisplay = netImpact > 0 ? `+${netImpact}` : netImpact.toString();

            // Build chip badge if applicable
            let chipBadge = '';
            if (reason === 'freehit') chipBadge = '<span class="tinkering-badge freehit">FH</span>';
            else if (reason === 'wildcard') chipBadge = '<span class="tinkering-badge wildcard">WC</span>';

            // Build transfers in section
            let transfersInHtml = '';
            if (transfersIn && transfersIn.length > 0) {
                const totalIn = transfersIn.reduce((sum, t) => sum + t.points, 0);
                transfersInHtml = `
                    <div class="tinkering-section">
                        <div class="tinkering-section-title positive">Transfers In (+${totalIn} pts)</div>
                        ${transfersIn.map(t => `
                            <div class="tinkering-item">
                                <span>${t.player.name}${t.captained ? ' (C)' : ''}</span>
                                <span class="points positive">${t.points} pts</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Build transfers out section
            let transfersOutHtml = '';
            if (transfersOut && transfersOut.length > 0) {
                const totalOut = transfersOut.reduce((sum, t) => sum + t.points, 0);
                transfersOutHtml = `
                    <div class="tinkering-section">
                        <div class="tinkering-section-title negative">Transfers Out (-${totalOut} pts)</div>
                        ${transfersOut.map(t => `
                            <div class="tinkering-item">
                                <span>${t.player.name}${t.wasCaptain ? ' (was C)' : ''}</span>
                                <span class="points negative">${t.points} pts</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Build captain change section
            let captainHtml = '';
            if (captainChange && captainChange.changed) {
                const capImpact = captainChange.impact;
                const capClass = capImpact > 0 ? 'positive' : (capImpact < 0 ? 'negative' : 'neutral');
                const capSign = capImpact > 0 ? '+' : '';
                captainHtml = `
                    <div class="tinkering-section">
                        <div class="tinkering-section-title ${capClass}">Captain Change (${capSign}${capImpact} pts)</div>
                        <div class="tinkering-item">
                            <span>Changed from ${captainChange.oldCaptain?.name} (${captainChange.oldCaptain?.points}) to ${captainChange.newCaptain?.name} (${captainChange.newCaptain?.points})</span>
                        </div>
                    </div>
                `;
            }

            // Build lineup changes section
            let lineupHtml = '';
            const hasLineupChanges = (lineupChanges?.movedToStarting?.length > 0) || (lineupChanges?.movedToBench?.length > 0);
            if (hasLineupChanges) {
                let lineupItems = '';
                if (lineupChanges.movedToStarting?.length > 0) {
                    lineupItems += lineupChanges.movedToStarting.map(p => `
                        <div class="tinkering-item">
                            <span>Started ${p.name}</span>
                            <span class="points positive">+${p.points} pts</span>
                        </div>
                    `).join('');
                }
                if (lineupChanges.movedToBench?.length > 0) {
                    lineupItems += lineupChanges.movedToBench.map(p => `
                        <div class="tinkering-item">
                            <span>Benched ${p.name}</span>
                            <span class="points negative">-${p.points} pts</span>
                        </div>
                    `).join('');
                }
                lineupHtml = `
                    <div class="tinkering-section">
                        <div class="tinkering-section-title">Lineup Changes</div>
                        ${lineupItems}
                    </div>
                `;
            }

            return `
                <div class="tinkering-bar" onclick="toggleTinkeringBar(this)">
                    <div class="tinkering-header">
                        <div class="tinkering-title">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>
                            Tinkering Impact${chipBadge}
                        </div>
                        <div>
                            <span class="tinkering-impact ${impactClass}">${impactDisplay} pts</span>
                            <span class="tinkering-toggle">&#9660;</span>
                        </div>
                    </div>
                    <div class="tinkering-details">
                        <div class="tinkering-summary">
                            <div class="tinkering-row">
                                <span>If you kept last week's team:</span>
                                <span>${hypotheticalScore} pts</span>
                            </div>
                            <div class="tinkering-row">
                                <span>Your actual score:</span>
                                <span>${actualScore} pts</span>
                            </div>
                            ${transferCost > 0 ? `
                            <div class="tinkering-row">
                                <span>Transfer hits:</span>
                                <span class="tinkering-impact negative">-${transferCost} pts</span>
                            </div>
                            ` : ''}
                            <div class="tinkering-row total">
                                <span>NET BENEFIT:</span>
                                <span class="tinkering-impact ${impactClass}">${impactDisplay} pts</span>
                            </div>
                        </div>
                        ${transfersInHtml}
                        ${transfersOutHtml}
                        ${captainHtml}
                        ${lineupHtml}
                    </div>
                </div>
            `;
        }

        function toggleTinkeringBar(element) {
            element.classList.toggle('expanded');
        }

        function showTooltip(event, playerId) {
            if (isMobile) return;
            const player = currentPicksData?.players.find(p => p.id === playerId);
            if (!player) return;

            const breakdown = player.pointsBreakdown || [];
            const tooltip = document.getElementById('tooltip');

            let statsHtml = `<div class="tooltip-header">${player.fullName || player.name}</div>`;

            if (breakdown.length === 0) {
                statsHtml += `<div class="tooltip-row"><span class="stat">No points yet</span><span></span><span></span></div>`;
            } else {
                breakdown.forEach(item => {
                    const ptsColor = item.points < 0 ? 'color: #e74c3c;' : 'color: #4ade80;';
                    const icon = item.icon || '';
                    statsHtml += `
                        <div class="tooltip-row">
                            <span class="stat">${icon} ${item.stat}</span>
                            <span class="value">${item.value}</span>
                            <span class="pts" style="${ptsColor}">${item.points}</span>
                        </div>`;
                });
            }

            statsHtml += `
                <div class="tooltip-row total">
                    <span class="stat">Total</span>
                    <span></span>
                    <span class="pts">${player.totalPoints || player.points}</span>
                </div>`;

            tooltip.innerHTML = statsHtml;
            tooltip.style.left = `${event.clientX + 10}px`;
            tooltip.style.top = `${event.clientY + 10}px`;
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        function handlePlayerClick(playerId) {
            if (!isMobile) return;
            showPlayerSheet(playerId);
        }

        function showPlayerSheet(playerId) {
            const player = currentPicksData?.players.find(p => p.id === playerId);
            if (!player) return;

            const breakdown = player.pointsBreakdown || [];
            const colors = player.teamColors || { primary: '#333', secondary: '#fff' };
            const basePoints = player.totalPoints || player.points || 0;
            // Subbed-in players get x1, captains x2, otherwise use multiplier
            const effectiveMultiplier = player.subIn ? 1 : (player.isCaptain ? 2 : player.multiplier);
            const pts = basePoints * effectiveMultiplier;

            let breakdownHtml = '';
            if (breakdown.length === 0) {
                breakdownHtml = '<div class="breakdown-row"><span>No points yet</span></div>';
            } else {
                breakdown.forEach(item => {
                    const ptsClass = item.points < 0 ? 'negative' : '';
                    const icon = item.icon || '';
                    breakdownHtml += `
                        <div class="breakdown-row">
                            <span class="breakdown-stat">${icon} ${item.stat}</span>
                            <span class="breakdown-value">${item.value}</span>
                            <span class="breakdown-pts ${ptsClass}">${item.points} pts</span>
                        </div>
                    `;
                });
            }

            const teamCode = player.teamCode || 1;
            const shirtSuffix = player.positionId === 1 ? '_1' : '';
            const shirtUrl = `https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${teamCode}${shirtSuffix}-110.webp`;

            let html = `
                <div class="player-sheet-header">
                    <div class="player-sheet-badge">
                        <img src="${shirtUrl}" alt="${player.teamName}">
                    </div>
                    <div class="player-sheet-info">
                        <h3>${player.fullName || player.name}</h3>
                        <p>${player.teamName} - ${player.position}</p>
                    </div>
                    <div class="player-sheet-points">${pts}</div>
                </div>
                <div class="points-breakdown">
                    <div class="breakdown-header">
                        <span>Statistic</span>
                        <span style="text-align:center">Value</span>
                        <span style="text-align:right">Points</span>
                    </div>
                    ${breakdownHtml}
                    <div class="breakdown-total">
                        <span>Total</span>
                        <span></span>
                        <span>${player.totalPoints || player.points} pts</span>
                    </div>
                </div>
            `;

            document.getElementById('player-sheet').innerHTML = html;
            document.getElementById('sheet-overlay').classList.add('visible');
            document.getElementById('player-sheet').classList.add('visible');
        }

        function closePlayerSheet() {
            document.getElementById('sheet-overlay').classList.remove('visible');
            document.getElementById('player-sheet').classList.remove('visible');
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-overlay').classList.remove('active');
            document.body.style.overflow = '';
            currentPicksData = null;
            currentTinkeringData = null;
            currentModalGW = null;
            currentModalEntryId = null;
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closePlayerSheet();
            }
        });

        window.addEventListener('resize', () => {
            isMobile = window.innerWidth < 768;
        });

        loadWeekData();
    </script>
</body>
</html>
