<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon-192.png">
    <link rel="manifest" href="/manifest.json">
    <title>Admin - FPL League</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .login-card, .admin-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .login-card h2, .admin-card h2 {
            margin: 0 0 1rem 0;
            font-size: 1.25rem;
            color: var(--white);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--white);
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--primary);
        }

        .btn-primary:hover {
            background: #00cc6a;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-msg {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .success-msg {
            background: rgba(0, 255, 135, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .info-msg {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #3498db;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .hidden {
            display: none;
        }

        .warning-box {
            background: rgba(241, 196, 15, 0.15);
            border-left: 4px solid #f1c40f;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
        }

        .warning-box strong {
            color: #f1c40f;
        }

        .action-desc {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
        }

        .logout-link {
            display: block;
            text-align: center;
            margin-top: 1rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .logout-link:hover {
            color: var(--white);
        }

        /* Log Viewer Styles */
        .log-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .log-controls select, .log-controls input {
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--white);
            font-size: 0.8rem;
        }

        .log-controls select { min-width: 120px; }
        .log-controls input[type="text"] { flex: 1; min-width: 150px; }

        .log-controls select:focus, .log-controls input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .log-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .log-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .log-stat .count { font-weight: 700; margin-right: 0.3rem; }
        .log-stat.errors .count { color: var(--danger); }
        .log-stat.warns .count { color: #f1c40f; }
        .log-stat.infos .count { color: #3498db; }
        .log-stat.total .count { color: var(--accent); }

        .log-entries {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.75rem;
            line-height: 1.5;
        }

        .log-entry {
            padding: 0.3rem 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }

        .log-entry:hover { background: rgba(255, 255, 255, 0.03); }

        .log-time {
            color: rgba(255, 255, 255, 0.4);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .log-level {
            font-weight: 700;
            text-transform: uppercase;
            width: 3.5em;
            flex-shrink: 0;
            text-align: center;
            border-radius: 3px;
            padding: 0 0.25rem;
        }

        .log-level.error { color: #fff; background: var(--danger); }
        .log-level.warn { color: #000; background: #f1c40f; }
        .log-level.info { color: #fff; background: #2980b9; }
        .log-level.debug { color: #ccc; background: rgba(255,255,255,0.1); }

        .log-cat {
            color: var(--accent);
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 5em;
        }

        .log-msg {
            color: rgba(255, 255, 255, 0.85);
            word-break: break-word;
            flex: 1;
        }

        .log-entry.error .log-msg { color: #e74c3c; }

        .log-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .log-pagination button {
            padding: 0.4rem 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--white);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .log-pagination button:hover { border-color: var(--accent); }
        .log-pagination button:disabled { opacity: 0.3; cursor: not-allowed; }

        .log-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .log-toolbar .btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        .log-empty {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .log-auto-refresh {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .log-auto-refresh input[type="checkbox"] { accent-color: var(--accent); }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-inner">
            <a href="/" class="navbar-brand"><img src="/favicon.png" alt="">Barry's FPL Mini League</a>
            <button class="nav-toggle" onclick="this.classList.toggle('active');document.querySelector('.navbar-links').classList.toggle('active')">
                <span></span><span></span><span></span>
            </button>
            <div class="navbar-links">
                <a href="/">Home</a>
                <a href="/week">Scores</a>
                <a href="/h2h">Head to Head</a>
                <a href="/losers">Weekly Losers</a>
                <a href="/motm">Manager of the Month</a>
                <a href="/chips">Chips</a>
                <a href="/earnings">Earnings</a>
                <a href="/cup">Cup</a>
                <a href="/hall-of-fame">Hall of Fame</a>
                <a href="/set-and-forget">Set & Forget</a>
                <a href="/rules">Rules</a>
                <a href="/admin" class="mobile-only active">Admin</a>
            </div>
        </div>
    </nav>

    <div class="page-header">
        <h1>Admin Panel</h1>
        <p class="subtitle">League Management</p>
    </div>

    <main>
        <div class="admin-container">
            <!-- Login Form -->
            <div class="login-card" id="login-section">
                <h2>Admin Login</h2>
                <div id="login-error" class="error-msg hidden"></div>
                <form id="login-form" onsubmit="login(event)">
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary" id="login-btn">Login</button>
                </form>
            </div>

            <!-- Admin Actions (hidden until logged in) -->
            <div id="admin-section" class="hidden">
                <div class="admin-card">
                    <h2>Rebuild Historical Data</h2>
                    <div id="rebuild-msg" class="hidden"></div>
                    <div class="warning-box">
                        <strong>Note:</strong> This clears all cached gameweek data and re-fetches fresh data
                        from the FPL API. Use this if historical scores appear incorrect (e.g., missing chip bonuses).
                    </div>
                    <p class="action-desc">
                        Clears picks cache, live data cache, processed picks cache, and tinkering cache,
                        then rebuilds all data from the FPL API. This may take a few minutes.
                    </p>
                    <button class="btn btn-primary" onclick="rebuildHistoricalData()" id="rebuild-btn">
                        Rebuild All Historical Data
                    </button>
                </div>

                <div class="admin-card">
                    <h2>Archive Current Season</h2>
                    <div id="archive-msg" class="hidden"></div>
                    <div class="warning-box">
                        <strong>Warning:</strong> This will archive all current season data to Redis storage.
                        Only use this at the end of the season when all 38 gameweeks are complete.
                    </div>
                    <p class="action-desc">
                        Archives standings, losers, MotM, chips, earnings, and hall of fame data
                        for the current season so it can be viewed in future seasons.
                    </p>
                    <button class="btn btn-danger" onclick="archiveSeason()" id="archive-btn">
                        Archive Season Data
                    </button>
                </div>

                <div class="admin-card">
                    <h2>System Logs</h2>
                    <p class="action-desc">
                        View detailed server logs with filtering. Logs are retained for 3 days.
                    </p>

                    <div id="log-stats" class="log-stats"></div>

                    <div class="log-controls">
                        <select id="log-level" onchange="loadLogs()">
                            <option value="">All Levels</option>
                            <option value="error">Errors</option>
                            <option value="warn">Warnings</option>
                            <option value="info">Info</option>
                            <option value="debug">Debug</option>
                        </select>
                        <select id="log-category" onchange="loadLogs()">
                            <option value="">All Categories</option>
                        </select>
                        <select id="log-time" onchange="loadLogs()">
                            <option value="">All Time (3 days)</option>
                            <option value="3600000">Last Hour</option>
                            <option value="21600000">Last 6 Hours</option>
                            <option value="86400000">Last 24 Hours</option>
                        </select>
                        <input type="text" id="log-search" placeholder="Search logs..." onkeyup="debounceSearch()">
                    </div>

                    <div class="log-toolbar">
                        <div class="log-auto-refresh">
                            <input type="checkbox" id="log-auto-refresh" checked onchange="toggleAutoRefresh()">
                            <label for="log-auto-refresh">Auto-refresh (10s)</label>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="loadLogs()" style="margin-right: 0.5rem;">Refresh</button>
                            <button class="btn btn-danger" onclick="clearAllLogs()">Clear Logs</button>
                        </div>
                    </div>

                    <div id="log-entries" class="log-entries">
                        <div class="log-empty">Loading logs...</div>
                    </div>

                    <div class="log-pagination">
                        <button id="log-prev" onclick="changePage(-1)" disabled>&laquo; Newer</button>
                        <span id="log-page-info">-</span>
                        <button id="log-next" onclick="changePage(1)" disabled>Older &raquo;</button>
                    </div>
                </div>

                <span class="logout-link" onclick="logout()">Logout</span>
            </div>
        </div>
    </main>

    <script>
        let adminPassword = null;

        async function login(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('login-btn');

            btn.disabled = true;
            btn.textContent = 'Verifying...';
            errorEl.classList.add('hidden');

            try {
                const res = await fetch('/api/admin/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (res.ok) {
                    adminPassword = password;
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('admin-section').classList.remove('hidden');
                } else {
                    errorEl.textContent = 'Invalid password';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                errorEl.textContent = 'Error: ' + error.message;
                errorEl.classList.remove('hidden');
            }

            btn.disabled = false;
            btn.textContent = 'Login';
        }

        function logout() {
            adminPassword = null;
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('password').value = '';
        }

        async function archiveSeason() {
            if (!adminPassword) {
                alert('Please login first');
                return;
            }

            if (!confirm('Are you sure you want to archive the current season? This should only be done at the end of the season.')) {
                return;
            }

            const msgEl = document.getElementById('archive-msg');
            const btn = document.getElementById('archive-btn');

            btn.disabled = true;
            btn.textContent = 'Archiving...';
            msgEl.classList.add('hidden');

            try {
                const res = await fetch('/api/archive-season', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    msgEl.className = 'success-msg';
                    msgEl.textContent = 'Season archived successfully! Data saved for: ' + (data.season || 'current season');
                } else {
                    msgEl.className = 'error-msg';
                    msgEl.textContent = data.error || 'Failed to archive season';
                }
                msgEl.classList.remove('hidden');
            } catch (error) {
                msgEl.className = 'error-msg';
                msgEl.textContent = 'Error: ' + error.message;
                msgEl.classList.remove('hidden');
            }

            btn.disabled = false;
            btn.textContent = 'Archive Season Data';
        }

        let rebuildPollInterval = null;

        async function rebuildHistoricalData() {
            if (!adminPassword) {
                alert('Please login first');
                return;
            }

            if (!confirm('This will clear all cached historical data and re-fetch from the FPL API. This may take 10-30 minutes. Continue?')) {
                return;
            }

            const msgEl = document.getElementById('rebuild-msg');
            const btn = document.getElementById('rebuild-btn');

            btn.disabled = true;
            btn.textContent = 'Starting rebuild...';
            msgEl.classList.add('hidden');

            try {
                // Start the rebuild (returns immediately)
                const res = await fetch('/api/admin/rebuild-historical-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    msgEl.className = 'error-msg';
                    msgEl.innerHTML = `<strong>Failed to start rebuild:</strong> ${data.error || 'Unknown error'}`;
                    msgEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = 'Rebuild All Historical Data';
                    return;
                }

                // Show initial status and start polling
                msgEl.className = 'info-msg';
                msgEl.innerHTML = `<strong>Rebuild started!</strong><br>
                    Cleared: ${data.cleared.picksCount} picks, ${data.cleared.liveDataCount} liveData,
                    ${data.cleared.processedCount} processed, ${data.cleared.tinkeringCount} tinkering<br>
                    <span id="rebuild-progress">Fetching data from FPL API...</span>`;
                msgEl.classList.remove('hidden');

                // Poll for status every 3 seconds
                pollRebuildStatus();
                rebuildPollInterval = setInterval(pollRebuildStatus, 3000);

            } catch (error) {
                msgEl.className = 'error-msg';
                msgEl.textContent = 'Error: ' + error.message;
                msgEl.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'Rebuild All Historical Data';
            }
        }

        async function pollRebuildStatus() {
            const msgEl = document.getElementById('rebuild-msg');
            const btn = document.getElementById('rebuild-btn');
            const progressEl = document.getElementById('rebuild-progress');

            try {
                const res = await fetch('/api/admin/rebuild-status');
                const status = await res.json();

                if (status.inProgress) {
                    // Update progress display
                    btn.textContent = `Rebuilding... (${status.elapsed || '0s'})`;
                    if (progressEl) {
                        const cacheInfo = status.cacheStats
                            ? `<br>Progress: ${status.cacheStats.picksCache} picks, ${status.cacheStats.liveDataCache} liveData, ${status.cacheStats.processedPicksCache} processed, ${status.cacheStats.tinkeringCache} tinkering cached`
                            : '';
                        progressEl.innerHTML = `${status.progress || 'Processing...'}${cacheInfo}`;
                    }
                } else {
                    // Rebuild complete - stop polling
                    clearInterval(rebuildPollInterval);
                    rebuildPollInterval = null;

                    if (status.phase === 'complete') {
                        msgEl.className = 'success-msg';
                        const result = status.result || {};
                        const rebuilt = result.rebuilt || {};
                        msgEl.innerHTML = `<strong>Rebuild complete!</strong> (${result.duration || status.elapsed || 'unknown'})<br>
                            <strong>Rebuilt:</strong> ${rebuilt.picksCache || 0} picks, ${rebuilt.liveDataCache || 0} liveData,
                            ${rebuilt.processedPicksCache || 0} processed, ${rebuilt.tinkeringCache || 0} tinkering<br>
                            All data has been refreshed from the FPL API.`;
                    } else if (status.phase === 'failed') {
                        msgEl.className = 'error-msg';
                        msgEl.innerHTML = `<strong>Rebuild failed:</strong> ${status.error || 'Unknown error'}<br>Duration: ${status.elapsed || 'unknown'}`;
                    }

                    btn.disabled = false;
                    btn.textContent = 'Rebuild All Historical Data';
                }
            } catch (error) {
                // Don't stop polling on network errors - might be temporary
                console.error('Status poll error:', error);
            }
        }
        // ============================
        // Log Viewer
        // ============================
        const LOG_PAGE_SIZE = 200;
        let logOffset = 0;
        let logTotal = 0;
        let logAutoRefreshTimer = null;
        let logSearchTimer = null;

        function debounceSearch() {
            clearTimeout(logSearchTimer);
            logSearchTimer = setTimeout(() => loadLogs(), 400);
        }

        async function loadLogs() {
            if (!adminPassword) return;

            const level = document.getElementById('log-level').value;
            const category = document.getElementById('log-category').value;
            const search = document.getElementById('log-search').value;
            const timeRange = document.getElementById('log-time').value;

            const params = new URLSearchParams({ password: adminPassword, limit: LOG_PAGE_SIZE, offset: logOffset });
            if (level) params.set('level', level);
            if (category) params.set('category', category);
            if (search) params.set('search', search);
            if (timeRange) params.set('since', Date.now() - parseInt(timeRange, 10));

            try {
                const res = await fetch('/api/admin/logs?' + params.toString());
                if (!res.ok) return;
                const data = await res.json();

                logTotal = data.total;
                renderLogEntries(data.entries);
                updateLogPagination();
                populateCategoryFilter(data.categories);
            } catch (e) {
                console.error('Failed to load logs:', e);
            }

            loadLogStats();
        }

        async function loadLogStats() {
            if (!adminPassword) return;
            try {
                const res = await fetch('/api/admin/logs/stats?password=' + encodeURIComponent(adminPassword));
                if (!res.ok) return;
                const stats = await res.json();

                document.getElementById('log-stats').innerHTML =
                    `<span class="log-stat total"><span class="count">${stats.total}</span>total</span>` +
                    `<span class="log-stat errors"><span class="count">${stats.counts.error || 0}</span>errors</span>` +
                    `<span class="log-stat warns"><span class="count">${stats.counts.warn || 0}</span>warnings</span>` +
                    `<span class="log-stat infos"><span class="count">${stats.counts.info || 0}</span>info</span>`;
            } catch (e) { /* ignore */ }
        }

        function renderLogEntries(entries) {
            const container = document.getElementById('log-entries');
            if (!entries || entries.length === 0) {
                container.innerHTML = '<div class="log-empty">No log entries found</div>';
                return;
            }

            container.innerHTML = entries.map(e => {
                const d = new Date(e.t);
                const time = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) + ' ' +
                             d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const msg = escapeHtml(e.msg);
                return `<div class="log-entry ${e.level}">` +
                    `<span class="log-time">${time}</span>` +
                    `<span class="log-level ${e.level}">${e.level}</span>` +
                    `<span class="log-cat">[${escapeHtml(e.cat)}]</span>` +
                    `<span class="log-msg">${msg}</span>` +
                    `</div>`;
            }).join('');
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function updateLogPagination() {
            const prevBtn = document.getElementById('log-prev');
            const nextBtn = document.getElementById('log-next');
            const info = document.getElementById('log-page-info');

            const page = Math.floor(logOffset / LOG_PAGE_SIZE) + 1;
            const totalPages = Math.max(1, Math.ceil(logTotal / LOG_PAGE_SIZE));

            info.textContent = `Page ${page} of ${totalPages} (${logTotal} entries)`;
            prevBtn.disabled = logOffset === 0;
            nextBtn.disabled = logOffset + LOG_PAGE_SIZE >= logTotal;
        }

        function changePage(dir) {
            logOffset = Math.max(0, logOffset + dir * LOG_PAGE_SIZE);
            loadLogs();
        }

        function populateCategoryFilter(categories) {
            const select = document.getElementById('log-category');
            const current = select.value;
            // Keep first option, rebuild rest
            const opts = ['<option value="">All Categories</option>'];
            (categories || []).forEach(cat => {
                const selected = cat === current ? ' selected' : '';
                opts.push(`<option value="${escapeHtml(cat)}"${selected}>${escapeHtml(cat)}</option>`);
            });
            select.innerHTML = opts.join('');
        }

        async function clearAllLogs() {
            if (!adminPassword) return;
            if (!confirm('Clear all stored logs? This cannot be undone.')) return;

            try {
                await fetch('/api/admin/logs?password=' + encodeURIComponent(adminPassword), { method: 'DELETE' });
                logOffset = 0;
                loadLogs();
            } catch (e) {
                alert('Failed to clear logs: ' + e.message);
            }
        }

        function toggleAutoRefresh() {
            const checked = document.getElementById('log-auto-refresh').checked;
            if (checked) {
                startLogAutoRefresh();
            } else {
                stopLogAutoRefresh();
            }
        }

        function startLogAutoRefresh() {
            stopLogAutoRefresh();
            logAutoRefreshTimer = setInterval(loadLogs, 10000);
        }

        function stopLogAutoRefresh() {
            if (logAutoRefreshTimer) {
                clearInterval(logAutoRefreshTimer);
                logAutoRefreshTimer = null;
            }
        }

        // Override login to auto-load logs after auth
        const _originalLogin = login;
        login = async function(event) {
            await _originalLogin(event);
            if (adminPassword) {
                loadLogs();
                startLogAutoRefresh();
            }
        };

        // Override logout to stop log refresh
        const _originalLogout = logout;
        logout = function() {
            stopLogAutoRefresh();
            _originalLogout();
        };
    </script>
</body>
</html>
